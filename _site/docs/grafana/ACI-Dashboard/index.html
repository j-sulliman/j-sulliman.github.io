<!DOCTYPE html><html lang="en-US"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=Edge"><link rel="shortcut icon" href="/favicon.ico" type="image/x-icon"><link rel="stylesheet" href="/assets/css/just-the-docs-default.css"> <script async src="https://www.googletagmanager.com/gtag/js?id=UA-2709176-10"></script> <script> window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'UA-2709176-10', { 'anonymize_ip': true }); </script> <script type="text/javascript" src="/assets/js/just-the-docs.js"></script><meta name="viewport" content="width=device-width, initial-scale=1"><title>7.0 Cisco ACI Dashboard | Jamie Sullivan’s Blog</title><meta name="generator" content="Jekyll v4.3.1" /><meta property="og:title" content="7.0 Cisco ACI Dashboard" /><meta property="og:locale" content="en_US" /><meta name="description" content="Network automation, Data Center, Python, Infrastructure-as-code" /><meta property="og:description" content="Network automation, Data Center, Python, Infrastructure-as-code" /><link rel="canonical" href="http://0.0.0.0:4000/docs/grafana/ACI-Dashboard/" /><meta property="og:url" content="http://0.0.0.0:4000/docs/grafana/ACI-Dashboard/" /><meta property="og:site_name" content="Jamie Sullivan’s Blog" /><meta property="og:type" content="website" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="7.0 Cisco ACI Dashboard" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"WebPage","description":"Network automation, Data Center, Python, Infrastructure-as-code","headline":"7.0 Cisco ACI Dashboard","url":"http://0.0.0.0:4000/docs/grafana/ACI-Dashboard/"}</script><body> <svg xmlns="http://www.w3.org/2000/svg" style="display: none;"> <symbol id="svg-link" viewBox="0 0 24 24"><title>Link</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-link"><path d="M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71"></path><path d="M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71"></path> </svg> </symbol> <symbol id="svg-search" viewBox="0 0 24 24"><title>Search</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-search"> <circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line> </svg> </symbol> <symbol id="svg-menu" viewBox="0 0 24 24"><title>Menu</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line> </svg> </symbol> <symbol id="svg-arrow-right" viewBox="0 0 24 24"><title>Expand</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-right"><polyline points="9 18 15 12 9 6"></polyline> </svg> </symbol> <symbol id="svg-doc" viewBox="0 0 24 24"><title>Document</title><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-file"><path d="M13 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V9z"></path><polyline points="13 2 13 9 20 9"></polyline> </svg> </symbol> </svg><div class="side-bar"><div class="site-header"> <a href="http://0.0.0.0:4000/" class="site-title lh-tight"> Jamie Sullivan's Blog </a> <a href="#" id="menu-button" class="site-button"> <svg viewBox="0 0 24 24" class="icon"><use xlink:href="#svg-menu"></use></svg> </a></div><nav role="navigation" aria-label="Main" id="site-nav" class="site-nav"><ul class="nav-list"><li class="nav-list-item"><a href="http://0.0.0.0:4000/" class="nav-list-link">Home</a><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://0.0.0.0:4000/docs/NetDevOps-Other" class="nav-list-link">NetDevOps - all other articles</a><ul class="nav-list "><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/NetDevOps-Other/Intersight-automation-of-delivery-documentation/" class="nav-list-link">Intersight - Automation of Delivery Documentation</a><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/NetDevOps-Other/aci-configuration-importer/" class="nav-list-link">Nexus to ACI Configuration Importer</a><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/NetDevOps-Other/meraki-as-built-generator/" class="nav-list-link">Meraki As-Built Generator</a><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/NetDevOps-Other/provisioning-ucs-from-spreadsheet/" class="nav-list-link">Provisioning UCS from Spreadsheet</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://0.0.0.0:4000/docs/infrastructure-as-code" class="nav-list-link">Infrastructure as Code</a><ul class="nav-list "><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/infrastructure-as-code/ansible-dcnm/" class="nav-list-link">1. Deploying an EVPN and VXLAN Fabric with Ansible</a></ul><li class="nav-list-item active"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://0.0.0.0:4000/docs/grafana" class="nav-list-link">Grafana Django and Cisco APIs Dashboard</a><ul class="nav-list "><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/grafana/Introduction/" class="nav-list-link">1. Introduction</a><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/grafana/meraki/" class="nav-list-link">2. Building a Meraki Dashboard</a><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/grafana/dcnm-lab/" class="nav-list-link">3.1 DCNM Lab Build</a><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/grafana/dcnm-dashboard/" class="nav-list-link">3.2 Building a DCNM Dashboard</a><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/grafana/SDWAN-Lab-Build/" class="nav-list-link">4.1 Cisco SDWAN Lab Build</a><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/grafana/Cisco-SDWAN-Grafana/" class="nav-list-link">4.2 Cisco SDWAN and vManage Dashboard</a><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/grafana/OpenVuln-API/" class="nav-list-link">5.0 Cisco Vulnerability and PSIRTS Dashboard</a><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/grafana/DNAC-Grafana/" class="nav-list-link">6.0 Cisco DNAC Dashboard</a><li class="nav-list-item active"><a href="http://0.0.0.0:4000/docs/grafana/ACI-Dashboard/" class="nav-list-link active">7.0 Cisco ACI Dashboard</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://0.0.0.0:4000/docs/observability" class="nav-list-link">Observability</a><ul class="nav-list "><li class="nav-list-item "><a href="http://0.0.0.0:4000/docs/observability/dotnet-containers" class="nav-list-link">Part 1 - Instrumenting a dotnet6 container with appdynamics</a></ul><li class="nav-list-item"><a href="#" class="nav-list-expander"><svg viewBox="0 0 24 24"><use xlink:href="#svg-arrow-right"></use></svg></a><a href="http://0.0.0.0:4000/docs/SRE" class="nav-list-link">SRE - Learnings and Notes</a><ul class="nav-list "></ul></ul></nav><footer class="site-footer"> This site uses <a href="https://github.com/pmarsceill/just-the-docs">Just the Docs</a>, a documentation theme for Jekyll.</footer></div><div class="main" id="top"><div id="main-header" class="main-header"><nav aria-label="Auxiliary" class="aux-nav"><ul class="aux-nav-list"><li class="aux-nav-list-item"> <a href="https://www.linkedin.com/in/jamie-sullivan-71575421/" class="site-button" > Contact me on LinkedIn </a></ul></nav></div><div id="main-content-wrap" class="main-content-wrap"><nav aria-label="Breadcrumb" class="breadcrumb-nav"><ol class="breadcrumb-nav-list"><li class="breadcrumb-nav-list-item"><a href="http://0.0.0.0:4000/docs/grafana">Grafana Django and Cisco APIs Dashboard</a><li class="breadcrumb-nav-list-item"><span>7.0 Cisco ACI Dashboard</span></ol></nav><div id="main-content" class="main-content" role="main"><h1 id="71-introduction"> <a href="#71-introduction" class="anchor-heading" aria-labelledby="71-introduction"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.1 Introduction</h1><p>Here we are at the seventh and final regular update to our series on building a multi-domain visualisations dashboard.</p><p>Through this series we’ve covered examples that demonstrate some of what is possible with Cisco API’s to address the monitoring, visualisation and dashboard consolidation use case.</p><p>This update we look into Cisco’s software defined data center network solution, or ACI.<br /> <img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/ACI_Solution_overview.png?raw=true" alt="Solution Overview" /></p><p>As mentioned in part one of this series, the nice thing about django, and python in general is its extensibility and flexibility to address future requirements as they arise.</p><p>We’ll add additional functionality by incorporating Django’s send_mail function to provide customised, automated email alerting and the django_tables2 module to provide a web based view of all the tables stored in our database across all architectures.</p><p>We also:</p><ul><li>Explore the APICs APIs and build an ACI dashboard<li>Bring the functions and code we’ve covered together into a single program (while loop) that will run in the background<li>Provide consolidated dashboard examples - i.e. firmware and Performance<li>Provide an example of Django’s send mail function for email based notification when an object state changes</ul><p>Here’s an example of the dashboard for ACI that we’ll step through.</p><p><img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/ACI_Dash.png?raw=true" alt="ACI Dashboard" /></p><p>Before we get to that though - a couple of sentences about what this grafana dashboard is, and what it isn’t. What we have shown this series, is a way to build a consolidated or “multi-domain” dashboard using API based monitoring, python and opensource software.</p><p>What we haven’t shown is “Full Stack Observability”, “user and application experience”, for that here’s a couple of primer discussions:</p><ul><li><a href="https://www.sdxcentral.com/articles/news/cisco-melds-thousandeyes-appdynamics-for-full-stack-observability/2021/03/">SDx Central article on Full Stack observability</a><li><a href="https://blogs.cisco.com/networking/improving-application-experience-with-full-stack-observability">Application and User Experience on blogs.cisco.com</a>.</ul><blockquote><p>Both AppD and ThousandEyes, do have RESTful APIs, which means we could integrate feeds, metrics and data from both sources into our dashboard… (maybe in another update).</p></blockquote><h1 id="72-references"> <a href="#72-references" class="anchor-heading" aria-labelledby="72-references"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.2 References</h1><ul><li><a href="https://developer.cisco.com/site/aci/">ACI on DevNet</a><li><a href="https://github.com/search?q=cisco+aci">ACI GitHub Repos</a><li><a href="https://www.cisco.com/c/en/us/td/docs/switches/datacenter/aci/apic/sw/2-x/rest_cfg/2_1_x/b_Cisco_APIC_REST_API_Configuration_Guide/b_Cisco_APIC_REST_API_Configuration_Guide_chapter_01.html">APIC REST API Configuration Guide</a></ul><h1 id="73-lab-and-sandbox-environment"> <a href="#73-lab-and-sandbox-environment" class="anchor-heading" aria-labelledby="73-lab-and-sandbox-environment"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.3 Lab and Sandbox Environment</h1><p>Cisco provides a free <a href="https://software.cisco.com/download/home/285968390/type/286278832/release/4.2(7f)">APIC Simulator</a> that has a full featured API to test automation use cases against. If you have access to an ESX or VMWare Workstation/Fusion host, this is an excellent tool that I’ve used extensively in the past. If you prefer linux / KVM, until the Simulator’s supported on hypervisor’s other than VMWare, you’ll need to use the always-on <a href="https://developer.cisco.com/docs/aci/#!sandbox/aci-sandboxes">sandbox</a> APIC on devnet, or your own physical environment.</p><blockquote><p>I’ve had some success with past simulator versions converting from a .vmdk disk image to a .qcow2 format using the <a href="https://docs.openstack.org/image-guide/convert-images.html">qemu-img convert tool</a>, I haven’t been able to get this working with recent APIC simulator releases, the simulator powers on, startup script completes, however no management interface connectivity…interested to hear if anyone’s managed to get this working. Hopefully support for other hypervisors will be will be introduced in the future.</p></blockquote><hr /><h1 id="74-implementation"> <a href="#74-implementation" class="anchor-heading" aria-labelledby="74-implementation"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4 Implementation</h1><h1 id="741-create-our-aci-app-in-django"> <a href="#741-create-our-aci-app-in-django" class="anchor-heading" aria-labelledby="741-create-our-aci-app-in-django"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.1 Create our ACI App in Django</h1><p>Create the ACI directory structure.</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>venv<span class="o">)</span> % python manage.py startapp aci
</code></pre></div></div><p>If you’ve followed along with previous articles, we’ll now have directories for dcnm, dnac, meraki, openvuln, sdwan and ACI.</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">.</span>
├── aci
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations
│   │   └── __init__.py
│   ├── models.py
│   ├── tests.py
│   └── views.py
├── apps
│   ├── dcnm_api.py
│   ├── dnac_api.py
│   ├── meraki_api.py
│   ├── openvuln_api.py
│   └── sdwan_api.py
├── cisco_grafana
│   ├── __init__.py
│   ├── asgi.py
│   ├── settings.py
│   ├── urls.py
│   └── wsgi.py
├── dcnm
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations
│   ├── models.py
│   ├── tests.py
│   └── views.py
├── dnac
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── migrations
│   ├── models.py
│   ├── tests.py
│   └── views.py
├── manage.py
├── meraki
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── models.py
│   ├── tests.py
│   └── views.py
├── openvuln
│   ├── __init__.py
│   ├── admin.py
│   ├── apps.py
│   ├── models.py
│   ├── tests.py
│   └── views.py
└── sdwan
    ├── __init__.py
    ├── admin.py
    ├── apps.py
    ├── migrations
    ├── models.py
    ├── tests.py
    └── views.py

</code></pre></div></div><p>Add the aci app to Django’s <strong>settings.py</strong></p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Application definition
</span>
<span class="n">INSTALLED_APPS</span> <span class="o">=</span> <span class="p">[</span>
    <span class="s">'django.contrib.admin'</span><span class="p">,</span>
    <span class="s">'django.contrib.auth'</span><span class="p">,</span>
    <span class="s">'django.contrib.contenttypes'</span><span class="p">,</span>
    <span class="s">'django.contrib.sessions'</span><span class="p">,</span>
    <span class="s">'django.contrib.messages'</span><span class="p">,</span>
    <span class="s">'django.contrib.staticfiles'</span><span class="p">,</span>
    <span class="s">'meraki'</span><span class="p">,</span> <span class="c1"># Added in previous post
</span>    <span class="s">'dcnm'</span><span class="p">,</span> <span class="c1"># Added in previous post
</span>    <span class="s">'sdwan'</span><span class="p">,</span> <span class="c1"># Added in previous post
</span>    <span class="s">'openvuln'</span><span class="p">,</span> <span class="c1"># Added in previous post
</span>    <span class="s">'dnac'</span><span class="p">,</span> <span class="c1"># Added in previous post
</span>    <span class="s">'aci'</span><span class="p">,</span> <span class="c1"># &lt; - Add this
</span><span class="p">]</span>
</code></pre></div></div><hr /><h1 id="742-python-requests-functions"> <a href="#742-python-requests-functions" class="anchor-heading" aria-labelledby="742-python-requests-functions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.2 Python Requests Functions</h1><p>For consistency, we’re going to continue using the python requests functions to make our API calls to the APIC controller. There’s a full featured “Cobra” SDK that’s covered in the <a href="https://developer.cisco.com/site/aci/getting-started/">Introduction to Cisco ACI Programmability</a> series if you prefer to use that instead. The SDK can be downloaded from <a href="software.cisco.com">software.cisco.com</a>, or the apic itself <strong>http(s)://APIC address/cobra/_downloads/</strong></p><p>Create the <code class="language-plaintext highlighter-rouge">Apps &gt; aci_api.py</code> file - this will store all our ACI python functions.</p><h2 id="7421-making-an-api-call-to-the-apic"> <a href="#7421-making-an-api-call-to-the-apic" class="anchor-heading" aria-labelledby="7421-making-an-api-call-to-the-apic"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.2.1 Making an API call to the APIC</h2><p>Create the function below to retrieve the token that will be used to authenticate API calls.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">aci_get</span><span class="p">(</span><span class="n">mo_class</span><span class="p">,</span> <span class="n">mgt</span> <span class="o">=</span> <span class="s">''</span> <span class="p">,</span> <span class="n">usr</span> <span class="o">=</span> <span class="s">''</span><span class="p">,</span> <span class="n">pw</span> <span class="o">=</span> <span class="s">''</span><span class="p">):</span>
    <span class="n">base_url</span> <span class="o">=</span> <span class="p">(</span><span class="s">'https://%s/api/'</span> <span class="o">%</span> <span class="n">mgt</span><span class="p">)</span>
    <span class="n">cookies</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">name_pwd</span> <span class="o">=</span> <span class="p">{</span><span class="s">'aaaUser'</span><span class="p">:</span> <span class="p">{</span><span class="s">'attributes'</span><span class="p">:</span> <span class="p">{</span><span class="s">'name'</span><span class="p">:</span> <span class="n">usr</span><span class="p">,</span> <span class="s">'pwd'</span><span class="p">:</span> <span class="n">pw</span><span class="p">}}}</span>
    <span class="n">json_credentials</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">name_pwd</span><span class="p">)</span>

    <span class="c1"># log in to API
</span>    <span class="n">login_url</span> <span class="o">=</span> <span class="n">base_url</span> <span class="o">+</span> <span class="s">'aaaLogin.json'</span>
    <span class="n">post_response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">post</span><span class="p">(</span><span class="n">login_url</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="n">json_credentials</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">post_response</span><span class="p">.</span><span class="n">status_code</span> <span class="o">!=</span> <span class="mi">200</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"API Request Failed for {}"</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">mo_class</span><span class="p">))</span>



    <span class="c1"># get token from login response structure
</span>    <span class="n">auth</span> <span class="o">=</span> <span class="n">json</span><span class="p">.</span><span class="n">loads</span><span class="p">(</span><span class="n">post_response</span><span class="p">.</span><span class="n">text</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">login_attributes</span> <span class="o">=</span> <span class="n">auth</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s">'aaaLogin'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">]</span>
    <span class="k">except</span> <span class="nb">KeyError</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">"Unable to retrieve logon attributes - wrong username or password?"</span><span class="p">)</span>
    <span class="n">auth_token</span> <span class="o">=</span> <span class="n">login_attributes</span><span class="p">[</span><span class="s">'token'</span><span class="p">]</span>

    <span class="c1"># create cookie array from token
</span>    <span class="n">cookies</span><span class="p">[</span><span class="s">'APIC-Cookie'</span><span class="p">]</span> <span class="o">=</span> <span class="n">auth_token</span>
    <span class="n">sensor_url</span> <span class="o">=</span> <span class="p">(</span><span class="n">base_url</span> <span class="o">+</span> <span class="s">'/node/class/'</span> <span class="o">+</span> <span class="n">mo_class</span><span class="p">)</span>
    <span class="n">get_response</span> <span class="o">=</span> <span class="n">requests</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">sensor_url</span><span class="p">,</span> <span class="n">cookies</span><span class="o">=</span><span class="n">cookies</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">).</span><span class="n">json</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">get_response</span>
</code></pre></div></div><h2 id="7422-retrieve-a-list-of-epgs-and-attached-endpoints"> <a href="#7422-retrieve-a-list-of-epgs-and-attached-endpoints" class="anchor-heading" aria-labelledby="7422-retrieve-a-list-of-epgs-and-attached-endpoints"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.2.2 Retrieve a list of EPG’s and Attached endpoints</h2><p>Let’s test the function against the API endpoint for EPGs. The <strong>rsp-subtree=full</strong> string in the API call, will return all child objects of the EPG, including attached endpoints, associated bridge and VMM domains, path bindings.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">epgs</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'fvAEPg.json?rsp-subtree=full'</span><span class="p">,</span> <span class="n">mgt</span><span class="o">=</span><span class="s">'sandboxapicdc.cisco.com'</span><span class="p">,</span>
        <span class="n">usr</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'ciscopsdt'</span><span class="p">)</span>
<span class="n">pp</span><span class="p">.</span><span class="n">pprint</span><span class="p">(</span><span class="n">epgs</span><span class="p">)</span>
</code></pre></div></div><p>Run the script from shell and check the output. You can explore the API documentation for the APIC at the URL <strong>https://apic-ip/doc/html/</strong>, or the object browser <strong>https://apic-ip/visore.html</strong></p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>venv<span class="o">)</span> % python aci_api.py
<span class="o">{</span><span class="s1">'fvAEPg'</span>: <span class="o">{</span><span class="s1">'attributes'</span>: <span class="o">{</span><span class="s1">'annotation'</span>: <span class="s1">''</span>,
                                       <span class="s1">'childAction'</span>: <span class="s1">''</span>,
                                       <span class="s1">'configIssues'</span>: <span class="s1">''</span>,
                                       <span class="s1">'configSt'</span>: <span class="s1">'applied'</span>,
                                       <span class="s1">'descr'</span>: <span class="s1">''</span>,
                                       <span class="s1">'dn'</span>: <span class="s1">'uni/tn-SnV/ap-Power_Up/epg-Database'</span>,
                                       <span class="s1">'exceptionTag'</span>: <span class="s1">''</span>,
                                       <span class="s1">'extMngdBy'</span>: <span class="s1">''</span>,
                                       <span class="s1">'floodOnEncap'</span>: <span class="s1">'disabled'</span>,
                                       <span class="s1">'fwdCtrl'</span>: <span class="s1">''</span>,
                                       <span class="s1">'hasMcastSource'</span>: <span class="s1">'no'</span>,
                                       <span class="s1">'isAttrBasedEPg'</span>: <span class="s1">'no'</span>,
                                       <span class="s1">'isSharedSrvMsiteEPg'</span>: <span class="s1">'no'</span>,
                                       <span class="s1">'lcOwn'</span>: <span class="s1">'local'</span>,
                                       <span class="s1">'matchT'</span>: <span class="s1">'AtleastOne'</span>,
                                       <span class="s1">'modTs'</span>: <span class="s1">'2021-06-03T02:35:58.130+00:00'</span>,
                                       <span class="s1">'monPolDn'</span>: <span class="s1">'uni/tn-common/monepg-default'</span>,
                                       <span class="s1">'name'</span>: <span class="s1">'Database'</span>,
                                       <span class="s1">'nameAlias'</span>: <span class="s1">''</span>,
                                       <span class="s1">'pcEnfPref'</span>: <span class="s1">'unenforced'</span>,
                                       <span class="s1">'pcTag'</span>: <span class="s1">'16392'</span>,
                                       <span class="s1">'prefGrMemb'</span>: <span class="s1">'exclude'</span>,
                                       <span class="s1">'prio'</span>: <span class="s1">'unspecified'</span>,
                                       <span class="s1">'scope'</span>: <span class="s1">'3047424'</span>,
                                       <span class="s1">'shutdown'</span>: <span class="s1">'no'</span>,
                                       <span class="s1">'status'</span>: <span class="s1">''</span>,
                                       <span class="s1">'triggerSt'</span>: <span class="s1">'triggerable'</span>,
                                       <span class="s1">'txId'</span>: <span class="s1">'8070450532247928974'</span>,
                                       <span class="s1">'uid'</span>: <span class="s1">'15374'</span><span class="o">}</span>,
                        <span class="s1">'children'</span>: <span class="o">[{</span><span class="s1">'fvCEp'</span>: <span class="o">{</span><span class="s1">'attributes'</span>: <span class="o">{</span><span class="s1">'annotation'</span>: <span class="s1">''</span>,
                                                               <span class="s1">'childAction'</span>: <span class="s1">'deleteNonPresent'</span>,
                                                               <span class="s1">'contName'</span>: <span class="s1">''</span>,
                                                               <span class="s1">'encap'</span>: <span class="s1">'vlan-128'</span>,
                                                               <span class="s1">'extMngdBy'</span>: <span class="s1">''</span>,
                                                               <span class="s1">'id'</span>: <span class="s1">'0'</span>,
                                                               <span class="s1">'idepdn'</span>: <span class="s1">''</span>,
                                                               <span class="s1">'ip'</span>: <span class="s1">'10.193.102.2'</span>,
                                                               <span class="s1">'lcC'</span>: <span class="s1">'learned'</span>,
                                                               <span class="s1">'lcOwn'</span>: <span class="s1">'local'</span>,
                                                               <span class="s1">'mac'</span>: <span class="s1">'44:CD:BB:C0:00:00'</span>,
                                                               <span class="s1">'mcastAddr'</span>: <span class="s1">'not-applicable'</span>,
                                                               <span class="s1">'modTs'</span>: <span class="s1">'2021-06-03T02:39:32.589+00:00'</span>,
                                                               <span class="s1">'monPolDn'</span>: <span class="s1">'uni/tn-common/monepg-default'</span>,
                                                               <span class="s1">'name'</span>: <span class="s1">'44:CD:BB:C0:00:00'</span>,
                                                               <span class="s1">'nameAlias'</span>: <span class="s1">''</span>,
                                                               <span class="s1">'rn'</span>: <span class="s1">'cep-44:CD:BB:C0:00:00'</span>,
                                                               <span class="s1">'status'</span>: <span class="s1">''</span>,
                                                               <span class="s1">'uid'</span>: <span class="s1">'0'</span>,
                                                               <span class="s1">'uuid'</span>: <span class="s1">''</span>,
                                                               <span class="s1">'vmmSrc'</span>: <span class="s1">''</span><span class="o">}</span>,
                                                <span class="s1">'children'</span>: <span class="o">[{</span><span class="s1">'fvIp'</span>: <span class="o">{</span><span class="s1">'attributes'</span>: <span class="o">{</span><span class="s1">'addr'</span>: <span class="s1">'10.193.102.2'</span>,
                                                                                      <span class="s1">'annotation'</span>: <span class="s1">''</span>,
                                                                                      <span class="s1">'childAction'</span>: <span class="s1">'deleteNonPresent'</span>,
                                                                                      <span class="s1">'createTs'</span>: <span class="s1">'1970-01-01T00:00:00.000+00:00'</span>,
                                                                                      <span class="s1">'debugMACMessage'</span>: <span class="s1">''</span>,
                                                                                      <span class="s1">'extMngdBy'</span>: <span class="s1">''</span>,
                                                                                      <span class="s1">'lcOwn'</span>: <span class="s1">'local'</span>,
                                                                                      <span class="s1">'modTs'</span>: <span class="s1">'2021-06-03T02:39:32.589+00:00'</span>,
                                                                                      <span class="s1">'monPolDn'</span>: <span class="s1">'uni/tn-common/monepg-default'</span>,
                                                                                      <span class="s1">'rn'</span>: <span class="s1">'ip-[10.193.102.2]'</span>,
                                                                                      <span class="s1">'status'</span>: <span class="s1">''</span>,
                                                                                      <span class="s1">'uid'</span>: <span class="s1">'0'</span><span class="o">}</span>,
                                                                       <span class="s1">'children'</span>: <span class="o">[{</span><span class="s1">'fvReportingNode'</span>: <span class="o">{</span><span class="s1">'attributes'</span>: <span class="o">{</span><span class="s1">'childAction'</span>: <span class="s1">'deleteNonPresent'</span>,
                                                                                                                        <span class="s1">'createTs'</span>: <span class="s1">'1970-01-01T00:00:00.000+00:00'</span>,
                                                                                                                        <span class="s1">'id'</span>: <span class="s1">'102'</span>,
                                                                                                                        <span class="s1">'lcC'</span>: <span class="s1">''</span>,
                                                                                                                        <span class="s1">'lcOwn'</span>: <span class="s1">'local'</span>,
                                                                                                                        <span class="s1">'modTs'</span>: <span class="s1">'2021-06-03T02:39:32.589+00:00'</span>,
                                                                                                                        <span class="s1">'rn'</span>: <span class="s1">'node-102'</span>,
                                                                                                                        <span class="s1">'status'</span>: <span class="s1">''</span><span class="o">}}}]}}</span>,
                                                             <span class="o">{</span><span class="s1">'fvIp'</span>: <span class="o">{</span><span class="s1">'attributes'</span>: <span class="o">{</span><span class="s1">'addr'</span>: <span class="s1">'2222::66:2'</span>,
                                                                                      <span class="s1">'annotation'</span>: <span class="s1">''</span>,
                                                                                      <span class="s1">'childAction'</span>: <span class="s1">'deleteNonPresent'</span>,
                                                                                      <span class="s1">'createTs'</span>: <span class="s1">'1970-01-01T00:00:00.000+00:00'</span>,
                                                                                      <span class="s1">'debugMACMessage'</span>: <span class="s1">''</span>,
                                                                                      <span class="s1">'extMngdBy'</span>: <span class="s1">''</span>,
                                                                                      <span class="s1">'lcOwn'</span>: <span class="s1">'local'</span>,
                                                                                      <span class="s1">'modTs'</span>: <span class="s1">'2021-06-03T02:39:32.589+00:00'</span>,
                                                                                      <span class="s1">'monPolDn'</span>: <span class="s1">'uni/tn-common/monepg-default'</span>,
                                                                                      <span class="s1">'rn'</span>: <span class="s1">'ip-[2222::66:2]'</span>,
                                                                                      <span class="s1">'status'</span>: <span class="s1">''</span>,
                                                                                      <span class="s1">'uid'</span>: <span class="s1">'0'</span><span class="o">}</span>,
                                                                       <span class="s1">'children'</span>: <span class="o">[{</span><span class="s1">'fvReportingNode'</span>: <span class="o">{</span><span class="s1">'attributes'</span>: <span class="o">{</span><span class="s1">'childAction'</span>: <span class="s1">'deleteNonPresent'</span>,
                                                                                                                        <span class="s1">'createTs'</span>: <span class="s1">'1970-01-01T00:00:00.000+00:00'</span>,
                                                                                                                        <span class="s1">'id'</span>: <span class="s1">'102'</span>,
                                                                                                                        <span class="s1">'lcC'</span>: <span class="s1">''</span>,
                                                                                                                        <span class="s1">'lcOwn'</span>: <span class="s1">'local'</span>,
                                                                                                                        <span class="s1">'modTs'</span>: <span class="s1">'2021-06-03T02:39:32.589+00:00'</span>,
                                                                                                                        <span class="s1">'rn'</span>: <span class="s1">'node-102'</span>,
                                                                                                                        <span class="s1">'status'</span>: <span class="s1">''</span><span class="o">}}}]}}</span>,
                                                             <span class="o">{</span><span class="s1">'fvRsCEpToPathEp'</span>: <span class="o">{</span><span class="s1">'attributes'</span>: <span class="o">{</span><span class="s1">'childAction'</span>: <span class="s1">'deleteNonPresent'</span>,
                                                                                                 <span class="s1">'forceResolve'</span>: <span class="s1">'yes'</span>,
                                                                                                 <span class="s1">'lcC'</span>: <span class="s1">'learned'</span>,
                                                                                                 <span class="s1">'lcOwn'</span>: <span class="s1">'local'</span>,
                                                                                                 <span class="s1">'modTs'</span>: <span class="s1">'2021-06-03T02:39:32.589+00:00'</span>,
                                                                                                 <span class="s1">'rType'</span>: <span class="s1">'mo'</span>,
                                                                                                 <span class="s1">'rn'</span>: <span class="s1">'rscEpToPathEp-[topology/pod-1/protpaths-101-102/pathep-[SnV_FI-1B]]'</span>,
                                                                                                 <span class="s1">'state'</span>: <span class="s1">'formed'</span>,
                                                                                                 <span class="s1">'stateQual'</span>: <span class="s1">'none'</span>,
                                                                                                 <span class="s1">'status'</span>: <span class="s1">''</span>,
                                                                                                 <span class="s1">'tCl'</span>: <span class="s1">'fabricAPathEp'</span>,
                                                                                                 <span class="s1">'tDn'</span>: <span class="s1">'topology/pod-1/protpaths-101-102/pathep-[SnV_FI-1B]'</span>,
                                                                                                 <span class="s1">'tType'</span>: <span class="s1">'mo'</span><span class="o">}</span>,
                                                                                  <span class="s1">'children'</span>: <span class="o">[{</span><span class="s1">'fvReportingNode'</span>: <span class="o">{</span><span class="s1">'attributes'</span>: <span class="o">{</span><span class="s1">'childAction'</span>: <span class="s1">'deleteNonPresent'</span>,
                                                                                                                                   <span class="s1">'createTs'</span>: <span class="s1">'1970-01-01T00:00:00.000+00:00'</span>,
                                                                                                                                   <span class="s1">'id'</span>: <span class="s1">'102'</span>,
                                                                                                                                   <span class="s1">'lcC'</span>: <span class="s1">'learned'</span>,
                                                                                                                                   <span class="s1">'lcOwn'</span>: <span class="s1">'local'</span>,
                                                                                                                                   <span class="s1">'modTs'</span>: <span class="s1">'2021-06-03T02:39:32.589+00:00'</span>,
                                                                                                                                   <span class="s1">'rn'</span>: <span class="s1">'node-102'</span>,
                                                                                                                                   <span class="s1">'status'</span>: <span class="s1">''</span><span class="o">}}}]}}]}}</span>,
</code></pre></div></div><h1 id="743-django-models-file-and-database-definition"> <a href="#743-django-models-file-and-database-definition" class="anchor-heading" aria-labelledby="743-django-models-file-and-database-definition"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.3 Django Models file and Database Definition</h1><p>Create the following model definition in the <strong>aci &gt; models.py</strong> file - We’ll go ahead and create definitions for other objects of interest while we’re here:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.db</span> <span class="kn">import</span> <span class="n">models</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">from</span> <span class="nn">django.utils</span> <span class="kn">import</span> <span class="n">timezone</span>

<span class="c1"># Create your models here.
</span><span class="k">class</span> <span class="nc">aci_fvAEPg</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">apic_addr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">pcEnfPref</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">'none'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">tenant</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="s">'none'</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">bd_tDn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">fvRsDomAtt_tDn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">fvRsPathAtt</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">fvRsCons</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">fvRsProv</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">modTs</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">last_updated</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="p">.</span><span class="n">now</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">apic_addr</span>


<span class="k">class</span> <span class="nc">aci_firmwareRunning</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">apic_addr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">biosVer</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">descr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">install_date</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">last_updated</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="p">.</span><span class="n">now</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">apic_addr</span>

<span class="k">class</span> <span class="nc">aci_ethpmPhysIf</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">apic_addr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">operVlans</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">operMode</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">operSt</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">operSpeed</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">bundleIndex</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">backplaneMac</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">lastLinkStChg</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">last_updated</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="p">.</span><span class="n">now</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">apic_addr</span>

<span class="k">class</span> <span class="nc">aci_eqptIngrTotal1d</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">apic_addr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">node</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">bytesAvg</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">BigIntegerField</span><span class="p">()</span>
    <span class="n">pktsAvg</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">utilAvg</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">last_updated</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="p">.</span><span class="n">now</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">apic_addr</span>


<span class="k">class</span> <span class="nc">aci_fabricNodeHealth</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">apic_addr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">healthLast</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">IntegerField</span><span class="p">()</span>
    <span class="n">repIntvEnd</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">repIntvStart</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">last_updated</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="p">.</span><span class="n">now</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">apic_addr</span>

<span class="k">class</span> <span class="nc">aci_lc_status</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">apic_addr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">operSt</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">descr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">upTs</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">manufactureTs</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">last_updated</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="p">.</span><span class="n">now</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">switch_name</span>

<span class="k">class</span> <span class="nc">aci_cpu_status</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">apic_addr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">"null"</span><span class="p">)</span>
    <span class="n">idle_avg</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">idle_min</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">idle_max</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">user_avg</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">user_min</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">user_max</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kern_avg</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kern_min</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kern_max</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">FloatField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">last_updated</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="p">.</span><span class="n">now</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">switch_name</span>

<span class="k">class</span> <span class="nc">aci_fabric_node</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">apic_addr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">ser</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">role</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">fabric_state</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="s">"null"</span><span class="p">)</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">address</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">version</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">last_updated</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="p">.</span><span class="n">now</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">.</span><span class="n">switch_name</span>


<span class="k">class</span> <span class="nc">aci_bgpPeerEntry</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">apic_addr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">localIp</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">addr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">holdIntvl</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">kaIntvl</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">vrf</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">operSt</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">passwdSet</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">rtrId</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">last_updated</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="p">.</span><span class="n">now</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">().</span><span class="nb">filter</span><span class="p">(</span><span class="n">operSt</span><span class="o">=</span><span class="s">'established'</span><span class="p">))</span>


    <span class="k">def</span> <span class="nf">established</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">count</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">().</span><span class="nb">filter</span><span class="p">(</span><span class="n">operSt</span><span class="o">=</span><span class="s">'established'</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">count</span>


<span class="k">class</span> <span class="nc">aci_faultInst</span><span class="p">(</span><span class="n">models</span><span class="p">.</span><span class="n">Model</span><span class="p">):</span>
    <span class="n">apic_addr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">code</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">severity</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">subject</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">dn</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span> <span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">rule</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">descr</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">cause</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">lastTransition</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">created</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">changeSet</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">200</span><span class="p">)</span>
    <span class="n">ack</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">CharField</span><span class="p">(</span><span class="n">max_length</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
    <span class="n">last_updated</span> <span class="o">=</span> <span class="n">models</span><span class="p">.</span><span class="n">DateTimeField</span><span class="p">(</span><span class="n">default</span><span class="o">=</span><span class="n">timezone</span><span class="p">.</span><span class="n">now</span><span class="p">)</span>
    <span class="k">def</span> <span class="nf">__str__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="nb">all</span><span class="p">().</span><span class="nb">filter</span><span class="p">(</span><span class="n">operSt</span><span class="o">=</span><span class="s">'established'</span><span class="p">))</span>


</code></pre></div></div><p>Commit the model to postgres sql:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>venv<span class="o">)</span> % python manage.py makemigrations aci
Migrations <span class="k">for</span> <span class="s1">'aci'</span>:
  aci/migrations/0001_initial.py
    - Create model aci_bgpPeerEntry
    - Create model aci_cpu_status
    - Create model aci_eqptIngrTotal1d
    - Create model aci_ethpmPhysIf
    - Create model aci_fabric_node
    - Create model aci_fabricNodeHealth
    - Create model aci_faultInst
    - Create model aci_firmwareRunning
    - Create model aci_fvAEPg
    - Create model aci_lc_status

<span class="o">(</span>venv<span class="o">)</span> % python manage.py migrate aci       

Operations to perform:
  Apply all migrations: aci
</code></pre></div></div><p>You’ll see the tables we’ve created for ACI in PgAdmin, and if you’ve followed along with previous updates, the 30+ tables created for Meraki, SDWAN, DCNM, DNAC, OpenVuln API.</p><p><img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/final_tables.png?raw=true" alt="pgAdmin Final" /></p><p>Test the API calls as follows, you can pretty-print the output to validate:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code>
<span class="n">bds</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'fvBD.json?rsp-subtree=full'</span><span class="p">,</span> <span class="n">mgt</span><span class="o">=</span><span class="s">'APIC-IP'</span><span class="p">,</span>
        <span class="n">usr</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">)</span>

<span class="n">firmware</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'firmwareRunning.json?query-target=self'</span><span class="p">,</span> <span class="n">mgt</span><span class="o">=</span><span class="s">'APIC-IP'</span><span class="p">,</span>
        <span class="n">usr</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">)</span>

<span class="n">nodes</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'fabricNode.json'</span><span class="p">,</span> <span class="n">mgt</span><span class="o">=</span><span class="s">'APIC-IP'</span><span class="p">,</span>
        <span class="n">usr</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">)</span>

<span class="n">node_health</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'fabricNodeHealth.json?query-target=self'</span><span class="p">,</span> <span class="n">mgt</span><span class="o">=</span><span class="s">'APIC-IP'</span><span class="p">,</span>
        <span class="n">usr</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">)</span>

<span class="n">line_cards</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'eqptLC.json?query-target=self'</span><span class="p">,</span> <span class="n">mgt</span><span class="o">=</span><span class="s">'APIC-IP'</span><span class="p">,</span>
        <span class="n">usr</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">)</span>

<span class="n">cpu</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'procSysCPU5min.json?query-target=self'</span><span class="p">,</span> <span class="n">mgt</span><span class="o">=</span><span class="s">'APIC-IP'</span><span class="p">,</span>
        <span class="n">usr</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">)</span>

<span class="n">bgp_peer</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'bgpPeerEntry.json?query-target=self'</span><span class="p">,</span> <span class="n">mgt</span><span class="o">=</span><span class="s">'APIC-IP'</span><span class="p">,</span>
        <span class="n">usr</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">)</span>

<span class="n">faults</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'faultInst.json?query-target=self'</span><span class="p">,</span> <span class="n">mgt</span><span class="o">=</span><span class="s">'APIC-IP'</span><span class="p">,</span>
        <span class="n">usr</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">)</span>


</code></pre></div></div><h1 id="744-email-notifications-with-djangos-send_mail-module"> <a href="#744-email-notifications-with-djangos-send_mail-module" class="anchor-heading" aria-labelledby="744-email-notifications-with-djangos-send_mail-module"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.4 Email Notifications with Django’s send_mail module</h1><p>In part 6, we explored grafana’s alerting functions, while useful it had limitations in that it only supported bar/line graph types.</p><p>Django provides the send_mail module that allows email notifications to be sent from Django. We’ll use this to create alerting from our application if an object status changes, or configuration is modified.</p><p>With the call home email alert functionality of ACI and other Cisco products, do we really need to use a seperate function to implement email based alerts? Short answer, no. But if we wanted to include devices in our dashboard that don’t support call home this could be useul..worst case, we have sample code in our library to use for another project later.</p><p>In the example below we send an alert if a configuration change is made to an object. Configurable objects in ACI have a modified time stamp attribute or <strong>modTs</strong>. If this attribute changes between API calls, it would indicate that a configuration change has occurred.</p><p>Here a sample of the code we’ll use - which is pretty much saying, if the modified time stamp in our current API call, is different to the modified time stamp in our previous API call, send an email notifying that a configuration change has occured:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">if</span> <span class="n">prev_bd_state</span><span class="p">.</span><span class="n">modTs</span> <span class="o">!=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'modTs'</span><span class="p">]:</span>
        <span class="n">send_email</span><span class="p">(</span><span class="n">fromip</span><span class="o">=</span><span class="n">apic</span><span class="p">,</span> <span class="n">faulttype</span><span class="o">=</span><span class="s">"Configuration Change"</span><span class="p">,</span> <span class="n">dn</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                   <span class="n">description</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">],</span> <span class="n">timestamp</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()))</span>
</code></pre></div></div><p>In this second example, we check the faultInst objects for recent updates based on the <strong>lastTransition</strong> field. If the fault is less than 1000 seconds old, send an email with the fault type, code, severity:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">time_data</span> <span class="o">=</span> <span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'lastTransition'</span><span class="p">]</span>
            <span class="n">split_time_data</span> <span class="o">=</span> <span class="n">time_data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"+"</span><span class="p">)</span>
            <span class="n">struct_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">split_time_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="s">"%Y-%m-%dT%H:%M:%S.%f"</span><span class="p">)</span>
            <span class="n">time_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">time_diff</span> <span class="o">=</span> <span class="n">time_now</span> <span class="o">-</span> <span class="n">struct_time</span>
            <span class="k">if</span> <span class="n">time_diff</span><span class="p">.</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">send_email</span><span class="p">(</span><span class="n">fromip</span><span class="o">=</span><span class="s">"10.67.36.20"</span><span class="p">,</span> <span class="c1"># &lt; Edit to suite
</span>                           <span class="n">faulttype</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'type'</span><span class="p">],</span>
                           <span class="n">code</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'code'</span><span class="p">],</span>
                           <span class="n">severity</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'severity'</span><span class="p">],</span>
                           <span class="n">dn</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                           <span class="n">rule</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'rule'</span><span class="p">],</span>
                           <span class="n">description</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'descr'</span><span class="p">],</span>
                           <span class="n">cause</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'cause'</span><span class="p">],</span>
                           <span class="n">timestamp</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'lastTransition'</span><span class="p">])</span>
</code></pre></div></div><p>For the above functions to work, add similar to below to <code class="language-plaintext highlighter-rouge">settings.py</code>, in my case I’m using a personal gmail account:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># Mail Settings
</span><span class="n">EMAIL_BACKEND</span> <span class="o">=</span> <span class="s">'django.core.mail.backends.smtp.EmailBackend'</span>
<span class="n">EMAIL_HOST</span> <span class="o">=</span> <span class="s">'smtp.gmail.com'</span>
<span class="n">EMAIL_HOST_USER</span> <span class="o">=</span> <span class="s">'your-email@gmail.com'</span>
<span class="n">EMAIL_HOST_PASSWORD</span> <span class="o">=</span> <span class="s">'your-email-pw'</span> <span class="c1">#past the key or password app here
</span><span class="n">EMAIL_PORT</span> <span class="o">=</span> <span class="mi">587</span>
<span class="n">EMAIL_USE_TLS</span> <span class="o">=</span> <span class="bp">True</span>
<span class="n">DEFAULT_FROM_EMAIL</span> <span class="o">=</span> <span class="s">'cisco_grafana'</span>
</code></pre></div></div><p>Create an <code class="language-plaintext highlighter-rouge">apps / notifications.py</code> file and add the following:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.core.mail</span> <span class="kn">import</span> <span class="n">send_mail</span>

<span class="k">def</span> <span class="nf">send_email</span><span class="p">(</span>
    <span class="n">fromip</span><span class="p">,</span>
    <span class="n">faulttype</span><span class="p">,</span>
    <span class="n">code</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
    <span class="n">severity</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
    <span class="n">dn</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
    <span class="n">rule</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
    <span class="n">description</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
    <span class="n">cause</span><span class="o">=</span><span class="s">''</span><span class="p">,</span>
    <span class="n">timestamp</span><span class="o">=</span><span class="s">''</span><span class="p">):</span>

    <span class="n">data1</span> <span class="o">=</span> <span class="s">'From IP  Address: {} Type: {} Code: {} Severity: {} </span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
    <span class="n">fromip</span><span class="p">,</span> <span class="n">faulttype</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="n">severity</span><span class="p">)</span>
    <span class="n">data2</span> <span class="o">=</span> <span class="s">'DN: {} Rule: {} Desc: {} Cause: {} Transition: {}</span><span class="se">\n</span><span class="s">'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
    <span class="n">dn</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">description</span><span class="p">,</span> <span class="n">cause</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">)</span>

    <span class="n">send_mail</span><span class="p">(</span>
        <span class="c1"># Email subject
</span>        <span class="s">'Fault Code {} Severity {} raised at {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span>
            <span class="n">code</span><span class="p">,</span> <span class="n">severity</span><span class="p">,</span> <span class="n">timestamp</span><span class="p">),</span>
        <span class="c1"># Message body
</span>        <span class="n">data1</span> <span class="o">+</span> <span class="n">data2</span><span class="p">,</span>
        <span class="c1">#From Address
</span>        <span class="s">'your-email@gmail.com'</span><span class="p">,</span>
        <span class="c1">#To Address
</span>        <span class="p">[</span><span class="s">'your-to-address@gmail.com'</span><span class="p">],</span>
        <span class="n">fail_silently</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
</code></pre></div></div><p>And import the function towards the top of aci_api.py:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">notifications</span> <span class="kn">import</span> <span class="n">send_email</span>
</code></pre></div></div><p>We’ll use the send_email function below when comparing current API call data to previous API call entries in our database.</p><p>When run, we should receive email alerts as below when a new fault or configuration change is found: <img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/email_alert.png?raw=true" alt="email alert" /></p><p>To read more on the send_mail module see - <a href="https://docs.djangoproject.com/en/3.2/topics/email/">Sending Email</a>.</p><hr /><h1 id="745-writing-to-database"> <a href="#745-writing-to-database" class="anchor-heading" aria-labelledby="745-writing-to-database"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.5 Writing to Database</h1><p>Create the below function to write our request output to database using Django’s database abstraction API:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">def</span> <span class="nf">aci_fabric_node_update</span><span class="p">(</span><span class="n">mgt</span><span class="o">=</span><span class="s">'10.67.36.20'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">):</span>
    <span class="n">node_data</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'fabricNode.json'</span><span class="p">,</span> <span class="n">mgt</span><span class="p">,</span>
            <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">node_data</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">cdpIntfAddr</span> <span class="o">=</span><span class="s">''</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">node</span><span class="p">[</span><span class="s">'fabricNode'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">]</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">s1</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'node-'</span><span class="p">)</span>
            <span class="n">s3</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>

            <span class="n">node_entry</span> <span class="o">=</span> <span class="n">aci_fabric_node</span><span class="p">(</span><span class="n">apic_addr</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span>
                    <span class="n">dn</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">'fabricNode'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                    <span class="n">ser</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">'fabricNode'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'serial'</span><span class="p">],</span>
                    <span class="n">role</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">'fabricNode'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'role'</span><span class="p">],</span>
                    <span class="n">name</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">'fabricNode'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'name'</span><span class="p">],</span>
                    <span class="nb">id</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">'fabricNode'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'id'</span><span class="p">],</span>
                    <span class="n">model</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">'fabricNode'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'model'</span><span class="p">],</span>
                    <span class="n">fabric_state</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">'fabricNode'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'fabricSt'</span><span class="p">],</span>
                    <span class="n">address</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">'fabricNode'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'address'</span><span class="p">],</span>
                    <span class="n">version</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">'fabricNode'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'version'</span><span class="p">],</span>
                    <span class="p">)</span>
            <span class="n">node_entry</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Unable to query Fabric Node on APIC {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">mgt</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">aci_fvBD_update</span><span class="p">(</span><span class="n">mgt</span><span class="o">=</span><span class="s">'10.67.36.20'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">):</span>
    <span class="n">fvBD_data</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">"fvBD.json?rsp-subtree=full"</span><span class="p">,</span> <span class="n">mgt</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fvBD</span> <span class="ow">in</span> <span class="n">fvBD_data</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">]:</span>
        <span class="c1">#try:
</span>            <span class="n">fvRsBDToOut1</span> <span class="o">=</span> <span class="s">''</span>
            <span class="n">fvRsBDToOut2</span> <span class="o">=</span> <span class="s">''</span>
            <span class="n">fvRsBDToOut3</span> <span class="o">=</span> <span class="s">''</span>
            <span class="n">fvSubnet1</span> <span class="o">=</span> <span class="s">''</span>
            <span class="n">fvSubnet2</span> <span class="o">=</span> <span class="s">''</span>
            <span class="n">fvSubnet3</span> <span class="o">=</span> <span class="s">''</span>
            <span class="n">fvSubnet1_scope</span> <span class="o">=</span> <span class="s">''</span>
            <span class="n">fvSubnet2_scope</span> <span class="o">=</span> <span class="s">''</span>
            <span class="n">fvSubnet3_scope</span> <span class="o">=</span> <span class="s">''</span>
            <span class="n">fvRsCtx</span> <span class="o">=</span> <span class="s">''</span>
            <span class="k">for</span> <span class="n">fvbd_child</span> <span class="ow">in</span> <span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">"children"</span><span class="p">]:</span>
                <span class="k">if</span> <span class="s">"fvRsBDToOut"</span> <span class="ow">in</span> <span class="n">fvbd_child</span> <span class="ow">and</span> <span class="n">fvRsBDToOut1</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span>
                    <span class="n">fvRsBDToOut1</span> <span class="o">=</span> <span class="n">fvbd_child</span><span class="p">[</span><span class="s">'fvRsBDToOut'</span><span class="p">][</span><span class="s">"attributes"</span><span class="p">][</span><span class="s">'tDn'</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s">"fvRsBDToOut"</span> <span class="ow">in</span> <span class="n">fvbd_child</span> <span class="ow">and</span> <span class="n">fvRsBDToOut2</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span>
                    <span class="n">fvRsBDToOut2</span> <span class="o">=</span> <span class="n">fvbd_child</span><span class="p">[</span><span class="s">'fvRsBDToOut'</span><span class="p">][</span><span class="s">"attributes"</span><span class="p">][</span><span class="s">'tDn'</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s">"fvRsBDToOut"</span> <span class="ow">in</span> <span class="n">fvbd_child</span> <span class="ow">and</span> <span class="n">fvRsBDToOut3</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span>
                    <span class="n">fvRsBDToOut3</span> <span class="o">=</span> <span class="n">fvbd_child</span><span class="p">[</span><span class="s">'fvRsBDToOut'</span><span class="p">][</span><span class="s">"attributes"</span><span class="p">][</span><span class="s">'tDn'</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s">"fvSubnet"</span> <span class="ow">in</span> <span class="n">fvbd_child</span> <span class="ow">and</span> <span class="n">fvSubnet1</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span>
                    <span class="n">fvSubnet1</span> <span class="o">=</span> <span class="n">fvbd_child</span><span class="p">[</span><span class="s">'fvSubnet'</span><span class="p">][</span><span class="s">"attributes"</span><span class="p">][</span><span class="s">'ip'</span><span class="p">]</span>
                    <span class="n">fvSubnet1_scope</span> <span class="o">=</span> <span class="n">fvbd_child</span><span class="p">[</span><span class="s">'fvSubnet'</span><span class="p">][</span><span class="s">"attributes"</span><span class="p">][</span><span class="s">'scope'</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s">"fvSubnet"</span> <span class="ow">in</span> <span class="n">fvbd_child</span> <span class="ow">and</span> <span class="n">fvSubnet2</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span>
                    <span class="n">fvSubnet2</span> <span class="o">=</span> <span class="n">fvbd_child</span><span class="p">[</span><span class="s">'fvSubnet'</span><span class="p">][</span><span class="s">"attributes"</span><span class="p">][</span><span class="s">'ip'</span><span class="p">]</span>
                    <span class="n">fvSubnet2_scope</span> <span class="o">=</span> <span class="n">fvbd_child</span><span class="p">[</span><span class="s">'fvSubnet'</span><span class="p">][</span><span class="s">"attributes"</span><span class="p">][</span><span class="s">'scope'</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s">"fvSubnet"</span> <span class="ow">in</span> <span class="n">fvbd_child</span> <span class="ow">and</span> <span class="n">fvSubnet3</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span>
                    <span class="n">fvSubnet3</span> <span class="o">=</span> <span class="n">fvbd_child</span><span class="p">[</span><span class="s">'fvSubnet'</span><span class="p">][</span><span class="s">"attributes"</span><span class="p">][</span><span class="s">'ip'</span><span class="p">]</span>
                    <span class="n">fvSubnet3_scope</span> <span class="o">=</span> <span class="n">fvbd_child</span><span class="p">[</span><span class="s">'fvSubnet'</span><span class="p">][</span><span class="s">"attributes"</span><span class="p">][</span><span class="s">'scope'</span><span class="p">]</span>
                <span class="k">elif</span> <span class="s">"fvRsCtx"</span> <span class="ow">in</span> <span class="n">fvbd_child</span> <span class="ow">and</span> <span class="n">fvRsCtx</span> <span class="o">==</span> <span class="s">''</span><span class="p">:</span>
                    <span class="n">fvRsCtx</span> <span class="o">=</span> <span class="n">fvbd_child</span><span class="p">[</span><span class="s">'fvRsCtx'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'tDn'</span><span class="p">]</span>
            <span class="c1">#try:
</span>                <span class="n">prev_bd_state</span> <span class="o">=</span> <span class="n">aci_fvBD</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">dn</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">'fvBD'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">prev_bd_state</span><span class="p">.</span><span class="n">modTs</span> <span class="o">!=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'modTs'</span><span class="p">]:</span>
                        <span class="n">send_email</span><span class="p">(</span><span class="n">fromip</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span> <span class="n">faulttype</span><span class="o">=</span><span class="s">"Configuration Change"</span><span class="p">,</span> <span class="n">dn</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                                   <span class="n">description</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">],</span> <span class="n">timestamp</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()))</span>
            <span class="c1">#except:
</span>                <span class="c1">#print("Query for existing Object not found - New object?")
</span>            <span class="n">fvBD_entry</span> <span class="o">=</span> <span class="n">aci_fvBD</span><span class="p">(</span><span class="n">apic_addr</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span>
                                  <span class="n">descr</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'descr'</span><span class="p">],</span>
                                  <span class="n">dn</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                                  <span class="n">arpFlood</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'arpFlood'</span><span class="p">],</span>
                                  <span class="n">epMoveDetectMode</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'epMoveDetectMode'</span><span class="p">],</span>
                                  <span class="n">ipLearning</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'ipLearning'</span><span class="p">],</span>
                                  <span class="n">limitIpLearnToSubnets</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'limitIpLearnToSubnets'</span><span class="p">],</span>
                                  <span class="n">name</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'name'</span><span class="p">],</span>
                                  <span class="n">unicastRoute</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'unicastRoute'</span><span class="p">],</span>
                                  <span class="n">unkMacUcastAct</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'unkMacUcastAct'</span><span class="p">],</span>
                                  <span class="n">unkMcastAct</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'unkMcastAct'</span><span class="p">],</span>
                                  <span class="n">modTs</span><span class="o">=</span><span class="n">fvBD</span><span class="p">[</span><span class="s">"fvBD"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'modTs'</span><span class="p">],</span>
                                  <span class="n">fvSubnet1</span><span class="o">=</span><span class="n">fvSubnet1</span><span class="p">,</span> <span class="n">fvSubnet2</span><span class="o">=</span><span class="n">fvSubnet2</span><span class="p">,</span> <span class="n">fvSubnet3</span><span class="o">=</span><span class="n">fvSubnet3</span><span class="p">,</span>
                                  <span class="n">fvSubnet1_scope</span><span class="o">=</span><span class="n">fvSubnet1_scope</span><span class="p">,</span> <span class="n">fvSubnet2_scope</span><span class="o">=</span><span class="n">fvSubnet2_scope</span><span class="p">,</span>
                                  <span class="n">fvSubnet3_scope</span><span class="o">=</span><span class="n">fvSubnet3_scope</span><span class="p">,</span> <span class="n">fvRsBDToOut1</span><span class="o">=</span><span class="n">fvRsBDToOut1</span><span class="p">,</span> <span class="n">fvRsBDToOut2</span><span class="o">=</span><span class="n">fvRsBDToOut2</span><span class="p">,</span>
                                  <span class="n">fvRsBDToOut3</span><span class="o">=</span><span class="n">fvRsBDToOut3</span><span class="p">,</span> <span class="n">fvRsCtx</span><span class="o">=</span><span class="n">fvRsCtx</span>
                                  <span class="p">)</span>

            <span class="n">fvBD_entry</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="c1">#except:
</span>            <span class="c1">#print('Unable to query Bridge Domain on APIC {}'.format(mgt))
</span>
<span class="k">def</span> <span class="nf">aci_fvAEPg_update</span><span class="p">(</span><span class="n">mgt</span><span class="o">=</span><span class="s">'10.67.36.20'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">):</span>
    <span class="n">epg_data</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'fvAEPg.json?rsp-subtree=full'</span><span class="p">,</span> <span class="n">mgt</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">epg</span> <span class="ow">in</span> <span class="n">epg_data</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">]:</span>
        <span class="n">epg_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s">'fvRsPathAtt'</span><span class="p">:</span> <span class="p">[],</span> <span class="s">'fvRsDomAtt'</span><span class="p">:</span> <span class="p">[],</span> <span class="s">'fvRsCons'</span><span class="p">:</span> <span class="p">[],</span> <span class="s">'fvRsProv'</span><span class="p">:</span> <span class="p">[],</span> <span class="s">'fvRsBd'</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="n">tn_1</span> <span class="o">=</span> <span class="n">epg</span><span class="p">[</span><span class="s">'fvAEPg'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'-'</span><span class="p">)</span>
        <span class="n">tn_2</span> <span class="o">=</span> <span class="n">tn_1</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">prev_epg_state</span> <span class="o">=</span> <span class="n">aci_fvAEPg</span><span class="p">.</span><span class="n">objects</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="n">dn</span><span class="o">=</span><span class="n">epg</span><span class="p">[</span><span class="s">'fvAEPg'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">prev_epg_state</span> <span class="o">=</span> <span class="s">"null"</span>
        <span class="k">for</span> <span class="n">epg_child</span> <span class="ow">in</span> <span class="n">epg</span><span class="p">[</span><span class="s">"fvAEPg"</span><span class="p">][</span><span class="s">"children"</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s">'fvRsPathAtt'</span> <span class="ow">in</span> <span class="n">epg_child</span><span class="p">:</span>
                <span class="n">epg_dict</span><span class="p">[</span><span class="s">'fvRsPathAtt'</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">epg_child</span><span class="p">[</span><span class="s">'fvRsPathAtt'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'tDn'</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s">'fvRsDomAtt'</span> <span class="ow">in</span> <span class="n">epg_child</span><span class="p">:</span>
                <span class="n">epg_dict</span><span class="p">[</span><span class="s">'fvRsDomAtt'</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">epg_child</span><span class="p">[</span><span class="s">'fvRsDomAtt'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'tDn'</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s">'fvRsCons'</span> <span class="ow">in</span> <span class="n">epg_child</span><span class="p">:</span>
                <span class="n">epg_dict</span><span class="p">[</span><span class="s">'fvRsCons'</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">epg_child</span><span class="p">[</span><span class="s">'fvRsCons'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'tDn'</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s">'fvRsProv'</span> <span class="ow">in</span> <span class="n">epg_child</span><span class="p">:</span>
                <span class="n">epg_dict</span><span class="p">[</span><span class="s">'fvRsProv'</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">epg_child</span><span class="p">[</span><span class="s">'fvRsProv'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'tDn'</span><span class="p">])</span>
            <span class="k">elif</span> <span class="s">'fvRsBd'</span> <span class="ow">in</span> <span class="n">epg_child</span><span class="p">:</span>
                <span class="n">epg_dict</span><span class="p">[</span><span class="s">'fvRsBd'</span><span class="p">].</span><span class="n">append</span><span class="p">(</span><span class="n">epg_child</span><span class="p">[</span><span class="s">'fvRsBd'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'tDn'</span><span class="p">])</span>

        <span class="n">epg_entry</span> <span class="o">=</span> <span class="n">aci_fvAEPg</span><span class="p">(</span><span class="n">apic_addr</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span> <span class="n">dn</span><span class="o">=</span><span class="n">epg</span><span class="p">[</span><span class="s">'fvAEPg'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                               <span class="n">pcEnfPref</span><span class="o">=</span><span class="n">epg</span><span class="p">[</span><span class="s">'fvAEPg'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'pcEnfPref'</span><span class="p">],</span>
                               <span class="n">name</span><span class="o">=</span><span class="n">epg</span><span class="p">[</span><span class="s">'fvAEPg'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'name'</span><span class="p">],</span>
                               <span class="n">tenant</span><span class="o">=</span><span class="n">tn_2</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                               <span class="n">bd_tDn</span><span class="o">=</span><span class="n">epg_dict</span><span class="p">[</span><span class="s">'fvRsBd'</span><span class="p">],</span>
                               <span class="n">fvRsDomAtt_tDn</span><span class="o">=</span><span class="n">epg_dict</span><span class="p">[</span><span class="s">'fvRsDomAtt'</span><span class="p">],</span>
                               <span class="n">fvRsPathAtt</span><span class="o">=</span><span class="n">epg_dict</span><span class="p">[</span><span class="s">'fvRsPathAtt'</span><span class="p">],</span>
                               <span class="n">fvRsCons</span><span class="o">=</span><span class="n">epg_dict</span><span class="p">[</span><span class="s">'fvRsCons'</span><span class="p">],</span>
                               <span class="n">fvRsProv</span><span class="o">=</span><span class="n">epg_dict</span><span class="p">[</span><span class="s">'fvRsProv'</span><span class="p">],</span>
                               <span class="n">modTs</span><span class="o">=</span><span class="n">epg</span><span class="p">[</span><span class="s">'fvAEPg'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'modTs'</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">prev_epg_state</span> <span class="o">!=</span> <span class="s">'null'</span> <span class="ow">and</span> <span class="n">prev_epg_state</span><span class="p">.</span><span class="n">modTs</span> <span class="o">!=</span> <span class="n">epg</span><span class="p">[</span><span class="s">'fvAEPg'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'modTs'</span><span class="p">]:</span>
            <span class="n">send_email</span><span class="p">(</span><span class="n">fromip</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span> <span class="n">faulttype</span><span class="o">=</span><span class="s">"Configuration Change"</span><span class="p">,</span> <span class="n">dn</span><span class="o">=</span><span class="n">epg</span><span class="p">[</span><span class="s">'fvAEPg'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                       <span class="n">description</span><span class="o">=</span><span class="n">epg</span><span class="p">[</span><span class="s">'fvAEPg'</span><span class="p">],</span> <span class="n">timestamp</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()))</span>
        <span class="n">epg_entry</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">aci_firmwareRunning_update</span><span class="p">(</span><span class="n">mgt</span><span class="o">=</span><span class="s">'10.67.36.20'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">):</span>
    <span class="n">fw_data</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">"firmwareRunning.json?query-target=self"</span><span class="p">,</span> <span class="n">mgt</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fw</span> <span class="ow">in</span> <span class="n">fw_data</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">fw_entry</span> <span class="o">=</span> <span class="n">aci_firmwareRunning</span><span class="p">(</span>
                <span class="n">apic_addr</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span>
               <span class="n">dn</span><span class="o">=</span><span class="n">fw</span><span class="p">[</span><span class="s">"firmwareRunning"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
               <span class="n">biosVer</span><span class="o">=</span><span class="n">fw</span><span class="p">[</span><span class="s">"firmwareRunning"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'biosVer'</span><span class="p">],</span>
               <span class="n">version</span><span class="o">=</span><span class="n">fw</span><span class="p">[</span><span class="s">"firmwareRunning"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'version'</span><span class="p">],</span>
               <span class="n">descr</span><span class="o">=</span><span class="n">fw</span><span class="p">[</span><span class="s">"firmwareRunning"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'descr'</span><span class="p">],</span>
               <span class="n">install_date</span><span class="o">=</span><span class="n">fw</span><span class="p">[</span><span class="s">"firmwareRunning"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'ts'</span><span class="p">])</span>
            <span class="n">fw_entry</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Unable to query firmwareRunning on APIC {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">mgt</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">fabricNodeHealth</span><span class="p">(</span><span class="n">mgt</span><span class="o">=</span><span class="s">'10.67.36.20'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">):</span>
    <span class="n">nodes</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">"fabricNodeHealth.json?query-target=self"</span><span class="p">,</span> <span class="n">mgt</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">'fabricNodeHealth15min'</span> <span class="ow">in</span> <span class="n">node</span><span class="p">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">node_entry</span> <span class="o">=</span> <span class="n">aci_fabricNodeHealth</span><span class="p">(</span>
                   <span class="n">apic_addr</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span>
                   <span class="n">dn</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">"fabricNodeHealth15min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                   <span class="n">healthLast</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">"fabricNodeHealth15min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'healthLast'</span><span class="p">],</span>
                   <span class="n">repIntvEnd</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">"fabricNodeHealth15min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'repIntvEnd'</span><span class="p">],</span>
                   <span class="n">repIntvStart</span><span class="o">=</span><span class="n">node</span><span class="p">[</span><span class="s">"fabricNodeHealth15min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'repIntvStart'</span><span class="p">])</span>
                <span class="n">node_entry</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Unable to query Node Firmware on APIC {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">mgt</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">aci_eqptlc_update</span><span class="p">(</span><span class="n">mgt</span><span class="o">=</span><span class="s">'10.67.36.20'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">):</span>
    <span class="n">lc_data</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">"eqptLC.json?query-target=self"</span><span class="p">,</span> <span class="n">mgt</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">lc</span> <span class="ow">in</span> <span class="n">lc_data</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">lc_entry</span> <span class="o">=</span> <span class="n">aci_lc_status</span><span class="p">(</span><span class="n">apic_addr</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span>
                                    <span class="n">dn</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s">"eqptLC"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                                    <span class="n">ser</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s">"eqptLC"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'ser'</span><span class="p">],</span>
                                    <span class="nb">type</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s">"eqptLC"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'type'</span><span class="p">],</span>
                                    <span class="n">model</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s">"eqptLC"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'model'</span><span class="p">],</span>
                                    <span class="n">operSt</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s">"eqptLC"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'operSt'</span><span class="p">],</span>
                                    <span class="n">descr</span> <span class="o">=</span> <span class="n">lc</span><span class="p">[</span><span class="s">"eqptLC"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'descr'</span><span class="p">],</span>
                                     <span class="n">upTs</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s">"eqptLC"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'upTs'</span><span class="p">],</span>
                                     <span class="n">manufactureTs</span><span class="o">=</span><span class="n">lc</span><span class="p">[</span><span class="s">"eqptLC"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'mfgTm'</span><span class="p">]</span>
                                     <span class="p">)</span>
            <span class="n">lc_entry</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Unable to query eqptLC on APIC {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">mgt</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">aci_eqptingrtotal1d_update</span><span class="p">(</span><span class="n">mgt</span><span class="o">=</span><span class="s">'10.67.36.20'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">):</span>
    <span class="n">intf_data</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">"eqptIngrTotal1d.json?query-target=self"</span><span class="p">,</span> <span class="n">mgt</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">intf</span> <span class="ow">in</span> <span class="n">intf_data</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">intf</span><span class="p">[</span><span class="s">'eqptIngrTotal1d'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">]</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">s1</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'node-'</span><span class="p">)</span>
            <span class="n">s3</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
            <span class="n">intf_entry</span> <span class="o">=</span> <span class="n">aci_eqptIngrTotal1d</span><span class="p">(</span>
                <span class="n">apic_addr</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span>
                <span class="n">dn</span><span class="o">=</span><span class="n">intf</span><span class="p">[</span><span class="s">"eqptIngrTotal1d"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                <span class="n">node</span><span class="o">=</span><span class="n">s3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                 <span class="n">pktsAvg</span><span class="o">=</span><span class="n">intf</span><span class="p">[</span><span class="s">"eqptIngrTotal1d"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'pktsAvg'</span><span class="p">],</span>
                 <span class="n">utilAvg</span><span class="o">=</span><span class="n">intf</span><span class="p">[</span><span class="s">"eqptIngrTotal1d"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'utilAvg'</span><span class="p">],</span>
                 <span class="n">bytesAvg</span><span class="o">=</span><span class="n">intf</span><span class="p">[</span><span class="s">"eqptIngrTotal1d"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'bytesAvg'</span><span class="p">])</span>
            <span class="n">intf_entry</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Unable to query eqptIngrTotal1d on APIC {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">mgt</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">aci_cpu_status_update</span><span class="p">(</span><span class="n">mgt</span><span class="o">=</span><span class="s">'10.67.36.20'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">):</span>
    <span class="n">cpu_data</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">"procSysCPU5min.json?query-target=self"</span><span class="p">,</span> <span class="n">mgt</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">cpu</span> <span class="ow">in</span> <span class="n">cpu_data</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">cpu</span><span class="p">[</span><span class="s">'procSysCPU5min'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">]</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">s1</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'node-'</span><span class="p">)</span>
            <span class="n">s3</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
            <span class="n">cpu_entry</span> <span class="o">=</span> <span class="n">aci_cpu_status</span><span class="p">(</span>
                <span class="n">apic_addr</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span>
                <span class="n">dn</span><span class="o">=</span><span class="n">cpu</span><span class="p">[</span><span class="s">"procSysCPU5min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                <span class="n">idle_avg</span><span class="o">=</span><span class="n">cpu</span><span class="p">[</span><span class="s">"procSysCPU5min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'idleAvg'</span><span class="p">],</span>
                <span class="n">idle_min</span><span class="o">=</span><span class="n">cpu</span><span class="p">[</span><span class="s">"procSysCPU5min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'idleMin'</span><span class="p">],</span>
                <span class="n">idle_max</span><span class="o">=</span><span class="n">cpu</span><span class="p">[</span><span class="s">"procSysCPU5min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'idleMax'</span><span class="p">],</span>
                <span class="n">user_avg</span><span class="o">=</span><span class="n">cpu</span><span class="p">[</span><span class="s">"procSysCPU5min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'userAvg'</span><span class="p">],</span>
                <span class="n">user_min</span><span class="o">=</span><span class="n">cpu</span><span class="p">[</span><span class="s">"procSysCPU5min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'userMin'</span><span class="p">],</span>
                <span class="n">user_max</span><span class="o">=</span><span class="n">cpu</span><span class="p">[</span><span class="s">"procSysCPU5min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'userMax'</span><span class="p">],</span>
                <span class="n">kern_avg</span><span class="o">=</span><span class="n">cpu</span><span class="p">[</span><span class="s">"procSysCPU5min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'kernelAvg'</span><span class="p">],</span>
                <span class="n">kern_min</span><span class="o">=</span><span class="n">cpu</span><span class="p">[</span><span class="s">"procSysCPU5min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'kernelMin'</span><span class="p">],</span>
                <span class="n">kern_max</span><span class="o">=</span><span class="n">cpu</span><span class="p">[</span><span class="s">"procSysCPU5min"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'kernelMax'</span><span class="p">])</span>
            <span class="n">cpu_entry</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Unable to query procSysCPU5min on APIC {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">mgt</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">aci_bgpPeerEntry_update</span><span class="p">(</span><span class="n">mgt</span><span class="o">=</span><span class="s">'10.67.36.20'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">):</span>
    <span class="n">aci_bgpPeerEntry_data</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">'bgpPeerEntry.json?query-target=self'</span><span class="p">,</span> <span class="n">mgt</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">peer</span> <span class="ow">in</span> <span class="n">aci_bgpPeerEntry_data</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">peer</span><span class="p">[</span><span class="s">'bgpPeerEntry'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">]</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">s1</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">':'</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">s3</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
                <span class="n">s4</span> <span class="o">=</span> <span class="n">s3</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">s4</span> <span class="o">=</span> <span class="s">'overlay-1'</span>
            <span class="n">aci_peer_entry</span> <span class="o">=</span> <span class="n">aci_bgpPeerEntry</span><span class="p">(</span>
                <span class="n">apic_addr</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span> <span class="n">dn</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s">'bgpPeerEntry'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                <span class="n">localIp</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s">'bgpPeerEntry'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'localIp'</span><span class="p">],</span>
                <span class="n">addr</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s">'bgpPeerEntry'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'addr'</span><span class="p">],</span>
                <span class="n">rtrId</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s">'bgpPeerEntry'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'rtrId'</span><span class="p">],</span>
                <span class="n">vrf</span> <span class="o">=</span> <span class="n">s4</span><span class="p">,</span>
                <span class="n">operSt</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s">'bgpPeerEntry'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'operSt'</span><span class="p">],</span>
                <span class="n">holdIntvl</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s">'bgpPeerEntry'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'holdIntvl'</span><span class="p">],</span>
                <span class="n">kaIntvl</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s">'bgpPeerEntry'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'kaIntvl'</span><span class="p">],</span>
                <span class="n">passwdSet</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s">'bgpPeerEntry'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'passwdSet'</span><span class="p">],</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">peer</span><span class="p">[</span><span class="s">'bgpPeerEntry'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'type'</span><span class="p">])</span>
            <span class="n">aci_peer_entry</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Unable to query bgpPeerEntry on APIC {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">mgt</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">aci_fault_update</span><span class="p">(</span><span class="n">mgt</span><span class="o">=</span><span class="s">'10.67.36.20'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">):</span>
    <span class="n">fault_data</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">"faultInst.json?query-target=self"</span><span class="p">,</span> <span class="n">mgt</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">fault</span> <span class="ow">in</span> <span class="n">fault_data</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">aci_fault_entry</span> <span class="o">=</span> <span class="n">aci_faultInst</span><span class="p">(</span>
                <span class="n">apic_addr</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span>
                <span class="n">dn</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                <span class="nb">type</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'type'</span><span class="p">],</span>
                <span class="n">code</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'code'</span><span class="p">],</span>
                <span class="n">severity</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'severity'</span><span class="p">],</span>
                <span class="n">subject</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'subject'</span><span class="p">],</span>
                <span class="n">descr</span> <span class="o">=</span> <span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'descr'</span><span class="p">],</span>
                <span class="n">rule</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'rule'</span><span class="p">],</span>
                <span class="n">cause</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'cause'</span><span class="p">],</span>
                <span class="n">lastTransition</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'lastTransition'</span><span class="p">],</span>
                <span class="n">changeSet</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'changeSet'</span><span class="p">],</span>
                <span class="n">ack</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'ack'</span><span class="p">])</span>
            <span class="n">aci_fault_entry</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
            <span class="n">time_data</span> <span class="o">=</span> <span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'lastTransition'</span><span class="p">]</span>
            <span class="n">split_time_data</span> <span class="o">=</span> <span class="n">time_data</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">"+"</span><span class="p">)</span>
            <span class="n">struct_time</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">split_time_data</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                                                     <span class="s">"%Y-%m-%dT%H:%M:%S.%f"</span><span class="p">)</span>
            <span class="n">time_now</span> <span class="o">=</span> <span class="n">datetime</span><span class="p">.</span><span class="n">datetime</span><span class="p">.</span><span class="n">now</span><span class="p">()</span>
            <span class="n">time_diff</span> <span class="o">=</span> <span class="n">time_now</span> <span class="o">-</span> <span class="n">struct_time</span>
            <span class="k">if</span> <span class="n">time_diff</span><span class="p">.</span><span class="n">seconds</span> <span class="o">&lt;</span> <span class="mi">1000</span><span class="p">:</span>
                <span class="n">send_email</span><span class="p">(</span><span class="n">fromip</span><span class="o">=</span><span class="s">"10.67.36.20"</span><span class="p">,</span>
                           <span class="n">faulttype</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'type'</span><span class="p">],</span>
                           <span class="n">code</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'code'</span><span class="p">],</span>
                           <span class="n">severity</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'severity'</span><span class="p">],</span>
                           <span class="n">dn</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                           <span class="n">rule</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'rule'</span><span class="p">],</span>
                           <span class="n">description</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'descr'</span><span class="p">],</span>
                           <span class="n">cause</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'cause'</span><span class="p">],</span>
                           <span class="n">timestamp</span><span class="o">=</span><span class="n">fault</span><span class="p">[</span><span class="s">"faultInst"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'lastTransition'</span><span class="p">])</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Unable to query faultInst on APIC {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">mgt</span><span class="p">))</span>

<span class="k">def</span> <span class="nf">aci_ethpmphysif_update</span><span class="p">(</span><span class="n">mgt</span><span class="o">=</span><span class="s">'10.67.36.20'</span><span class="p">,</span> <span class="n">user</span><span class="o">=</span><span class="s">'admin'</span><span class="p">,</span> <span class="n">pw</span><span class="o">=</span><span class="s">'Cisco123!'</span><span class="p">):</span>
    <span class="n">phyif_data</span> <span class="o">=</span> <span class="n">aci_get</span><span class="p">(</span><span class="s">"ethpmPhysIf.json?query-target=self"</span><span class="p">,</span> <span class="n">mgt</span><span class="p">,</span> <span class="n">user</span><span class="p">,</span> <span class="n">pw</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">intf</span> <span class="ow">in</span> <span class="n">phyif_data</span><span class="p">[</span><span class="s">'imdata'</span><span class="p">]:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">s1</span> <span class="o">=</span> <span class="n">intf</span><span class="p">[</span><span class="s">'ethpmPhysIf'</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">]</span>
            <span class="n">s2</span> <span class="o">=</span> <span class="n">s1</span><span class="p">.</span><span class="n">split</span><span class="p">(</span><span class="s">'node-'</span><span class="p">)</span>
            <span class="n">s3</span> <span class="o">=</span> <span class="n">s2</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">split</span><span class="p">(</span><span class="s">'/'</span><span class="p">)</span>
            <span class="n">aci_ethpmphysif_entry</span> <span class="o">=</span> <span class="n">aci_ethpmPhysIf</span><span class="p">(</span>
                <span class="n">apic_addr</span><span class="o">=</span><span class="n">mgt</span><span class="p">,</span>
                <span class="n">dn</span><span class="o">=</span><span class="n">intf</span><span class="p">[</span><span class="s">"ethpmPhysIf"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'dn'</span><span class="p">],</span>
                <span class="n">node</span><span class="o">=</span><span class="n">s3</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
                <span class="n">operSt</span><span class="o">=</span><span class="n">intf</span><span class="p">[</span><span class="s">"ethpmPhysIf"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'operSt'</span><span class="p">],</span>
                <span class="n">operVlans</span><span class="o">=</span><span class="n">intf</span><span class="p">[</span><span class="s">"ethpmPhysIf"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'operVlans'</span><span class="p">],</span>
                <span class="n">operMode</span><span class="o">=</span><span class="n">intf</span><span class="p">[</span><span class="s">"ethpmPhysIf"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'operMode'</span><span class="p">],</span>
                <span class="n">operSpeed</span><span class="o">=</span><span class="n">intf</span><span class="p">[</span><span class="s">"ethpmPhysIf"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'operSpeed'</span><span class="p">],</span>
                <span class="n">bundleIndex</span> <span class="o">=</span> <span class="n">intf</span><span class="p">[</span><span class="s">"ethpmPhysIf"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'bundleIndex'</span><span class="p">],</span>
                <span class="n">backplaneMac</span><span class="o">=</span><span class="n">intf</span><span class="p">[</span><span class="s">"ethpmPhysIf"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'backplaneMac'</span><span class="p">],</span>
                <span class="n">lastLinkStChg</span><span class="o">=</span><span class="n">intf</span><span class="p">[</span><span class="s">"ethpmPhysIf"</span><span class="p">][</span><span class="s">'attributes'</span><span class="p">][</span><span class="s">'lastLinkStChg'</span><span class="p">])</span>
            <span class="n">aci_ethpmphysif_entry</span><span class="p">.</span><span class="n">save</span><span class="p">()</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">print</span><span class="p">(</span><span class="s">'Unable to query ethpmPhysIf on APIC {}'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">mgt</span><span class="p">))</span>
</code></pre></div></div><h1 id="746-aggregating-and-continuously-running-our-functions"> <a href="#746-aggregating-and-continuously-running-our-functions" class="anchor-heading" aria-labelledby="746-aggregating-and-continuously-running-our-functions"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.6 Aggregating and continuously running our functions</h1><p>Until now, we’ve been calling our API functions arbitrarily from our scripts, this being the last update, we’ll consolidate these into a single application via a While Loop so they can be aggregated and run continuously.</p><p>Create the file <code class="language-plaintext highlighter-rouge">cisco_grafana_main.py</code> in the root directory (the same directory level as <code class="language-plaintext highlighter-rouge">manage.py</code>) and add the following.</p><p>You can add the functions we created in previous articles here also. I’ve shown an example below for meraki, dcnm, dnac and aci functions.</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">apps.aci_api</span> <span class="kn">import</span> <span class="n">aci_fabric_node_update</span><span class="p">,</span> <span class="n">aci_fvBD_update</span>
<span class="kn">from</span> <span class="nn">apps.aci_api</span> <span class="kn">import</span> <span class="n">aci_fvAEPg_update</span><span class="p">,</span> <span class="n">aci_firmwareRunning_update</span>
<span class="kn">from</span> <span class="nn">apps.aci_api</span> <span class="kn">import</span> <span class="n">fabricNodeHealth</span><span class="p">,</span> <span class="n">aci_eqptlc_update</span>
<span class="kn">from</span> <span class="nn">apps.aci_api</span> <span class="kn">import</span> <span class="n">aci_eqptingrtotal1d_update</span><span class="p">,</span> <span class="n">aci_cpu_status_update</span>
<span class="kn">from</span> <span class="nn">apps.aci_api</span> <span class="kn">import</span> <span class="n">aci_bgpPeerEntry_update</span><span class="p">,</span> <span class="n">aci_fault_update</span>
<span class="kn">from</span> <span class="nn">apps.aci_api</span> <span class="kn">import</span> <span class="n">aci_ethpmphysif_update</span>
<span class="kn">from</span> <span class="nn">apps.meraki_api</span> <span class="kn">import</span> <span class="n">meraki_http_get</span><span class="p">,</span> <span class="n">meraki_orgs_to_db</span>
<span class="kn">from</span> <span class="nn">apps.meraki_api</span> <span class="kn">import</span> <span class="n">meraki_devices_to_db</span><span class="p">,</span> <span class="n">meraki_networks_to_db</span>
<span class="kn">from</span> <span class="nn">apps.dcnm_api</span> <span class="kn">import</span> <span class="n">get_dcnm_network_device</span><span class="p">,</span> <span class="n">get_dcnm_network_switch</span>
<span class="kn">from</span> <span class="nn">apps.dnac_api</span> <span class="kn">import</span> <span class="n">get_dnac_network_device</span><span class="p">,</span> <span class="n">get_dnac_issues</span>
<span class="kn">from</span> <span class="nn">apps.dnac_api</span> <span class="kn">import</span> <span class="n">get_dnac_site_health</span><span class="p">,</span> <span class="n">get_dnac_interfaces</span>

<span class="k">while</span> <span class="bp">True</span><span class="p">:</span>
    <span class="n">get_dcnm_network_switch</span><span class="p">(</span><span class="s">'/inventory/switches'</span><span class="p">)</span>
    <span class="n">get_dcnm_network_device</span><span class="p">(</span><span class="s">'/control/fabrics'</span><span class="p">)</span>
    <span class="n">get_dnac_issues</span><span class="p">(</span><span class="s">'dna/intent/api/v1/issues'</span><span class="p">)</span>
    <span class="n">get_dnac_site_health</span><span class="p">(</span><span class="s">'dna/intent/api/v1/site-health'</span><span class="p">)</span>
    <span class="n">get_dnac_network_device</span><span class="p">(</span><span class="s">'api/v1/network-device'</span><span class="p">)</span>
    <span class="n">get_dnac_interfaces</span><span class="p">(</span><span class="s">'api/v1/interface'</span><span class="p">)</span>
    <span class="n">org_resp</span><span class="p">,</span> <span class="n">api_status</span> <span class="o">=</span> <span class="n">meraki_http_get</span><span class="p">(</span><span class="n">meraki_url</span><span class="o">=</span><span class="s">'organizations'</span><span class="p">)</span>
    <span class="n">meraki_orgs_to_db</span><span class="p">(</span><span class="n">org_resp</span><span class="p">)</span>
    <span class="n">meraki_devices_to_db</span><span class="p">()</span>
    <span class="n">meraki_networks_to_db</span><span class="p">()</span>
    <span class="n">aci_cpu_status_update</span><span class="p">()</span>
    <span class="n">aci_fabric_node_update</span><span class="p">()</span>
    <span class="n">aci_fvBD_update</span><span class="p">()</span>
    <span class="n">aci_fvAEPg_update</span><span class="p">()</span>
    <span class="n">aci_firmwareRunning_update</span><span class="p">()</span>
    <span class="n">fabricNodeHealth</span><span class="p">()</span>
    <span class="n">aci_eqptlc_update</span><span class="p">()</span>
    <span class="n">aci_eqptingrtotal1d_update</span><span class="p">()</span>
    <span class="n">aci_bgpPeerEntry_update</span><span class="p">()</span>
    <span class="n">aci_fault_update</span><span class="p">()</span>
    <span class="n">aci_ethpmphysif_update</span><span class="p">()</span>

</code></pre></div></div><blockquote><p>Note - Consider adding a <strong>time.sleep(2)</strong> function or similar so you don’t DDoS your APIC :)</p></blockquote><p>Run the cisco_grafana_main.py app:</p><div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">(</span>venv<span class="o">)</span> % python cisco_grafana_main.py
API Request Successful <span class="k">for </span>fabricNode.json
API Request Successful <span class="k">for </span>fvBD.json?rsp-subtree<span class="o">=</span>full
API Request Successful <span class="k">for </span>fvAEPg.json?rsp-subtree<span class="o">=</span>full
API Request Successful <span class="k">for </span>firmwareRunning.json?query-target<span class="o">=</span>self
API Request Successful <span class="k">for </span>fabricNodeHealth.json?query-target<span class="o">=</span>self
API Request Successful <span class="k">for </span>eqptLC.json?query-target<span class="o">=</span>self
API Request Successful <span class="k">for </span>eqptIngrTotal1d.json?query-target<span class="o">=</span>self
API Request Successful <span class="k">for </span>procSysCPU5min.json?query-target<span class="o">=</span>self
</code></pre></div></div><hr /><h1 id="747-django-tables2"> <a href="#747-django-tables2" class="anchor-heading" aria-labelledby="747-django-tables2"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.7 Django Tables2</h1><p>The <a href="https://django-tables2.readthedocs.io/en/latest/pages/installation.html">Django Tables2</a> Module provides a web frontend that allows the viewing of our Postgres (or other database) tables.</p><p>Install django tables2: <code class="language-plaintext highlighter-rouge">pip install django-tables2</code></p><p>And ensure django_tables2 is added to settings.py &gt; Installed_Apps</p><blockquote><p>After installing, add ‘django_tables2’ to INSTALLED_APPS and make sure that “django.template.context_processors.request” is added to the context_processors in your template setting OPTIONS.</p></blockquote><p>Create the following in aci &gt; tables.py:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">django_tables2</span> <span class="k">as</span> <span class="n">tables</span>
<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">aci_fabric_node</span>

<span class="k">class</span> <span class="nc">aci_fabric_nodeTable</span><span class="p">(</span><span class="n">tables</span><span class="p">.</span><span class="n">Table</span><span class="p">):</span>
    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">aci_fabric_node</span>
        <span class="n">template_name</span> <span class="o">=</span> <span class="s">"django_tables2/bootstrap.html"</span>
</code></pre></div></div><p>aci &gt; views.py</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c1"># aci/views.py
</span><span class="kn">from</span> <span class="nn">django_tables2</span> <span class="kn">import</span> <span class="n">SingleTableView</span>

<span class="kn">from</span> <span class="nn">.models</span> <span class="kn">import</span> <span class="n">aci_fabric_node</span>
<span class="kn">from</span> <span class="nn">.tables</span> <span class="kn">import</span> <span class="n">aci_fabric_nodeTable</span>


<span class="k">class</span> <span class="nc">FabricNodeView</span><span class="p">(</span><span class="n">SingleTableView</span><span class="p">):</span>
    <span class="n">model</span> <span class="o">=</span> <span class="n">aci_fabric_node</span>
    <span class="n">table_class</span> <span class="o">=</span> <span class="n">aci_fabric_nodeTable</span>
    <span class="n">template_name</span> <span class="o">=</span> <span class="s">'aci/fabric-node.html'</span>
</code></pre></div></div><p>In aci &gt; templates &gt; aci &gt; fabric-node.html: <img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/fabric-node-template.png?raw=true" alt="Fabric Node Template" /></p><blockquote><p>Sorry, this web-site’s trying to interpret/process the jinja2 tags, you’ll have to make do with an image. Refer to the django-tables2 <a href="https://django-tables2.readthedocs.io/en/latest/pages/tutorial.html">tutorial</a> if you prefer to copy and paste.</p></blockquote><p>And in the base cisco-grafana urls.py file:</p><div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">from</span> <span class="nn">django.contrib</span> <span class="kn">import</span> <span class="n">admin</span>
<span class="kn">from</span> <span class="nn">django.urls</span> <span class="kn">import</span> <span class="n">path</span>

<span class="kn">from</span> <span class="nn">aci.views</span> <span class="kn">import</span> <span class="n">FabricNodeView</span>

<span class="n">urlpatterns</span> <span class="o">=</span> <span class="p">[</span>
    <span class="n">path</span><span class="p">(</span><span class="s">'admin/'</span><span class="p">,</span> <span class="n">admin</span><span class="p">.</span><span class="n">site</span><span class="p">.</span><span class="n">urls</span><span class="p">),</span>
    <span class="n">path</span><span class="p">(</span><span class="s">"aci-fabric-node/"</span><span class="p">,</span> <span class="n">FabricNodeView</span><span class="p">.</span><span class="n">as_view</span><span class="p">()),</span>
<span class="p">]</span>
</code></pre></div></div><p>Start django server <code class="language-plaintext highlighter-rouge">python manage.py runserver 0:8080</code> and browse to http://localhost:8080/aci-fabric-node/</p><p><img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/fabric_node_table.png?raw=true" alt="Fabric Node Table" /></p><p>Repeat the same for remaining models / Postgres tables that we’ve created. Reminder on the steps:</p><ul><li>Define the table under <code class="language-plaintext highlighter-rouge">aci &gt; table.py</code><li>Create the view and <code class="language-plaintext highlighter-rouge">aci &gt; views.py</code><li>Create the HTML template under <code class="language-plaintext highlighter-rouge">aci &gt; templates &gt; aci &gt; &lt;table-name&gt;.html</code><li>Add the URL pattern to <code class="language-plaintext highlighter-rouge">urls.py</code></ul><p>Some examples….</p><h5 id="epgs"> <a href="#epgs" class="anchor-heading" aria-labelledby="epgs"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> EPGS</h5><p><img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/EPG_Table.png?raw=true" alt="EPG Table" /></p><h5 id="bds"> <a href="#bds" class="anchor-heading" aria-labelledby="bds"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> BDs</h5><p><img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/BD_table.png?raw=true" alt="BD Table" /></p><h5 id="faults"> <a href="#faults" class="anchor-heading" aria-labelledby="faults"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Faults</h5><p><img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/Fault_Table.png?raw=true" alt="Faults Table" /></p><h5 id="firmware"> <a href="#firmware" class="anchor-heading" aria-labelledby="firmware"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Firmware</h5><p><img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/FW_Table.png?raw=true" alt="Firmware Table" /></p><h5 id="bgp"> <a href="#bgp" class="anchor-heading" aria-labelledby="bgp"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> BGP</h5><p><img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/BGP_Table.png?raw=true" alt="BGP Table" /></p><p>The same process can be used for the tables we built for the previous architectures we’ve covered, to create a window into the database tables holding all the information we’ve captured across environments. Using markdown language, we can create hyperlinks to these tables within a textbox in our grafana dashboards.</p><h1 id="748-grafana"> <a href="#748-grafana" class="anchor-heading" aria-labelledby="748-grafana"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.4.8 Grafana</h1><p>Let’s create our dashboard to show, device and interface detail, issues, software versions, network health and text panels using markdown language.</p><ul><li>Create a new dashboard<li>Add a new panel to show CPU Utilisation over time<li>Time Column = <strong>last_updated</strong><li>Metric Column = <strong>dn</strong><li>From the select column select <strong>user_avg</strong> &amp; <strong>kern_avg</strong> &amp; <strong>idle_avg</strong><li>Select <strong>Time Series</strong> from the right<li>Configure the table as needed</ul><p>Your preview pane should now look like below - click save and apply <img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/ACI_CPU_graph.png?raw=true" alt="Network Health" /></p><ul><li>Add another panel<li>Table = <strong>aci_aci_cpu_status</strong><li>Time Column = <strong>last_updated</strong><li>Metric Column = <strong>version</strong><li>From the select column select <strong>column : version</strong> &amp; <strong>aggregate : count</strong> &amp; <strong>alias : version</strong><li>Select PieChartv2 from the right, optionally change the PieChart type to <strong>donut</strong>, add the labels name, value and percent and give the chart a title.</ul><p>Repeat as needed for interfaces, software or other metrics your interested in - see the dashboard example at the top of this page for examples.</p><p>Your preview pane should now look like below - click save and apply <img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/ACI_Version_pie.png?raw=true" alt="Platform Overview" /></p><p>Create a new panel to hold device detail as below</p><ul><li>From <strong>aci_aci_fabric_node</strong><li>Time Column = <strong>last_updated</strong><li>Metric Column = None<li>Format as table<li>Add required columns</ul><p>Your preview pane should now look like below - click save and apply. <img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/ACI_Node_table.png?raw=true" alt="Devices Table" /></p><p>Add other panels to your dashboard to suit your requirements. There’s some examples in the dashboard shown at the top of this page.</p><h1 id="75-aggregated-dashboards"> <a href="#75-aggregated-dashboards" class="anchor-heading" aria-labelledby="75-aggregated-dashboards"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> 7.5 Aggregated dashboards</h1><p>Some examples of creating aggregated dashboards by function across technology domains below.</p><h5 id="firmware-1"> <a href="#firmware-1" class="anchor-heading" aria-labelledby="firmware-1"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Firmware</h5><p><img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/aggregate_firmware.png?raw=true" alt="Firmware" /></p><h5 id="performance-and-network-health"> <a href="#performance-and-network-health" class="anchor-heading" aria-labelledby="performance-and-network-health"><svg viewBox="0 0 16 16" aria-hidden="true"><use xlink:href="#svg-link"></use></svg></a> Performance and Network Health</h5><p><img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/aggregate_perf_health.png?raw=true" alt="Performance Health" /></p><hr><footer><p><a href="#top" id="back-to-top">Back to top</a></p><p class="text-small text-grey-dk-100 mb-0">All content and views expressed here is my own and does not represent the views of my employer.</p><div class="d-flex mt-2"><p class="text-small text-grey-dk-000 mb-0 mr-2"> Page last modified: <span class="d-inline-block">Jun 3 2021 at 08:00 AM</span>.</p></div></footer></div></div></div>
