<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.7.1 -->
<title>[infrastructure as code] : using ansible to deploy a nexus 9000 evpn and vxlan fabric | Jamie Sullivan’s Blog</title>
<meta name="generator" content="Jekyll v4.2.0" />
<meta property="og:title" content="[infrastructure as code] : using ansible to deploy a nexus 9000 evpn and vxlan fabric" />
<meta name="author" content="Jamie Sullivan" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Introduction" />
<meta property="og:description" content="Introduction" />
<link rel="canonical" href="https://j-sulliman.github.io//2021/07/14/Infrastructure-As-Code-Using-Ansible-to-Deploy-a-Nexus-9000-EVPN-and-VXLAN-Fabric.html" />
<meta property="og:url" content="https://j-sulliman.github.io//2021/07/14/Infrastructure-As-Code-Using-Ansible-to-Deploy-a-Nexus-9000-EVPN-and-VXLAN-Fabric.html" />
<meta property="og:site_name" content="Jamie Sullivan’s Blog" />
<meta property="og:type" content="article" />
<meta property="article:published_time" content="2021-07-14T08:00:00+12:00" />
<meta name="twitter:card" content="summary" />
<meta property="twitter:title" content="[infrastructure as code] : using ansible to deploy a nexus 9000 evpn and vxlan fabric" />
<script type="application/ld+json">
{"headline":"[infrastructure as code] : using ansible to deploy a nexus 9000 evpn and vxlan fabric","dateModified":"2021-07-14T08:00:00+12:00","datePublished":"2021-07-14T08:00:00+12:00","url":"https://j-sulliman.github.io//2021/07/14/Infrastructure-As-Code-Using-Ansible-to-Deploy-a-Nexus-9000-EVPN-and-VXLAN-Fabric.html","author":{"@type":"Person","name":"Jamie Sullivan"},"@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://j-sulliman.github.io//2021/07/14/Infrastructure-As-Code-Using-Ansible-to-Deploy-a-Nexus-9000-EVPN-and-VXLAN-Fabric.html"},"description":"Introduction","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://j-sulliman.github.io//feed.xml" title="Jamie Sullivan&apos;s Blog" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Jamie Sullivan&#39;s Blog</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/about/">About</a><a class="page-link" href="/test.html">Home</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post h-entry" itemscope itemtype="http://schema.org/BlogPosting">

  <header class="post-header">
    <h1 class="post-title p-name" itemprop="name headline"> [infrastructure as code] : using ansible to deploy a nexus 9000 evpn and vxlan fabric</h1>
    <p class="post-meta">
      <time class="dt-published" datetime="2021-07-14T08:00:00+12:00" itemprop="datePublished">Jul 14, 2021
      </time>• <span itemprop="author" itemscope itemtype="http://schema.org/Person"><span class="p-author h-card" itemprop="name">Jamie Sullivan</span></span></p>
  </header>

  <div class="post-content e-content" itemprop="articleBody">
    <h1 id="introduction">Introduction</h1>

<p>Custom scripting and automation works well in the project space where there’s usually one or two delivery engineers  implementing the solution.  But what happens when the configuration automation tools need to be used, supported and maintained by a wider team on an ongoing basis?</p>

<p>Is the team equipped to maintain often poorly documented python code?  Who’s going to support and maintain that code if you leave?  Is it secure?  Free of bugs?</p>

<p>The further we progress from delivery - design, implementation to operational hand-over, the more important the choice and supportability of automation tools becomes.</p>

<p>This is where configuration automation or “Infrastructure as Code” tools such as Ansible have greater relevance, automation of environments at scale, where supportability and re-use by a wider team of engineers, each likely with varying levels of programming and automation skills…. “DevOps” environments.</p>

<p>In a <a href="https://j-sulliman.github.io/2021/05/04/Part-3.1-DCNM-Lab-Building-a-Multidomain-Dashboard-with-Cisco-APIs-and-Grafana.html">previous article</a> we stepped through creating a virtualised EVPN and VXLAN lab using DCNM and N9000vs. This article, I outline my learnings from my first real foray into Ansible (better late than never!) - using playbooks and templates to deploy a non DCNM controlled fabric.</p>

<h5 id="ansible-and-evpn-vxlan-deployment---adjust-the-playback-speed-to-suit">Ansible and EVPN VXLAN Deployment - adjust the playback speed to suit.</h5>

<iframe width="700" height="400" src="https://www.youtube.com/embed/OPMPnn5aJHY" frameborder="0" allow="autoplay; encrypted-media" allowfullscreen=""></iframe>

<blockquote>
  <p>Note: 9 of 10 times you will likely want to use a controller managed fabric solution - (APICs for ACI, DCNM for standalone) to automate, provision, manage your environment. The intent of this article is to document and share my learnings with Ansible and NXOS.</p>
</blockquote>

<h1 id="references-and-resources">References and Resources</h1>

<p>All of the ansible files, hosts, playbooks variables, used in this project can be found in the public github repository <a href="https://github.com/j-sulliman/ansible_nxos_evpn.git">ansible_nxos_evpn</a>.</p>

<p>Other resources I found really useful:</p>
<ul>
  <li>The free introductory Ansible course available from <a href="https://www.redhat.com/en/blog/new-free-ansible-course">RedHat</a>.</li>
  <li>The structured labs and learning available for Ansible that can be found on <a href="https://developer.cisco.com/automation-ansible/">DevNet</a>.</li>
  <li><a href="https://www.ciscolive.com/global/on-demand-library.html?search=ansible%20VXLAN#/session/1532112857665001tt4c">LTRDCN-1572 - Ondemand Learning Library</a>.  An excellent lab that forms the basis of the playbooks used here</li>
</ul>

<h1 id="lab-overview">Lab Overview</h1>

<h5 id="high-level-topology">High Level Topology</h5>

<p><img src="https://github.com/j-sulliman/j-sulliman.github.io/blob/master/images/Anisble_EVPN_VXLAN.png?raw=true" alt="ACI Dashboard" /></p>

<h4 id="virtual-appliances">Virtual Appliances</h4>

<table>
  <thead>
    <tr>
      <th>Appliance</th>
      <th>Image name</th>
      <th>Version</th>
      <th>Memory</th>
      <th>CPU</th>
      <th>Disk</th>
      <th>Qty</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>n9000v</td>
      <td>nexus9300v.9.3.7.qcow2</td>
      <td>9.3.7</td>
      <td>8096MB</td>
      <td>2vCPUs</td>
      <td>-</td>
      <td>6</td>
    </tr>
    <tr>
      <td>Ubuntu Desktop</td>
      <td>Ubuntu 20.10 (64bit).vmdk</td>
      <td>20.10</td>
      <td>1024MB</td>
      <td>1vCPUs</td>
      <td>-</td>
      <td>3</td>
    </tr>
  </tbody>
</table>

<h4 id="device-overview">Device Overview</h4>

<table>
  <thead>
    <tr>
      <th>Hostname</th>
      <th>MGT Addr</th>
      <th>Loopback0</th>
      <th>Loopback1</th>
      <th>Role</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>dc1-leaf-001</td>
      <td>192.168.200.113</td>
      <td>10.1.1.1/32</td>
      <td>10.1.1.111/32</td>
      <td>VTEP, BGP RR Client, Access</td>
    </tr>
    <tr>
      <td>dc1-leaf-002</td>
      <td>192.168.200.114</td>
      <td>10.1.1.2/32</td>
      <td>10.1.1.112/32</td>
      <td>VTEP, BGP RR Client, Access</td>
    </tr>
    <tr>
      <td>dc1-leaf-003</td>
      <td>192.168.200.115</td>
      <td>10.1.1.3/32</td>
      <td>10.1.1.113/32</td>
      <td>VTEP, BGP RR Client, Access</td>
    </tr>
    <tr>
      <td>dc1-leaf-004</td>
      <td>192.168.200.116</td>
      <td>10.1.1.4/32</td>
      <td>10.1.1.114/32</td>
      <td>VTEP, BGP RR Client, Access</td>
    </tr>
    <tr>
      <td>dc1-spine-001</td>
      <td>192.168.200.117</td>
      <td>10.1.1.101/32</td>
      <td>10.1.1.200/32</td>
      <td>BGP RR, PIM RP</td>
    </tr>
    <tr>
      <td>dc1-spine-001</td>
      <td>192.168.200.118</td>
      <td>10.1.1.102/32</td>
      <td>10.1.1.200/32</td>
      <td>BGP RR, PIM RP</td>
    </tr>
  </tbody>
</table>

<h4 id="underlay-interfaces---leafs">Underlay Interfaces - Leafs</h4>

<table>
  <thead>
    <tr>
      <th>Hostname</th>
      <th>Interface</th>
      <th>Description</th>
      <th>IP Address</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>dc1-leaf-001</td>
      <td>Ethernet1/1</td>
      <td>dc1-spine-001_E1/1</td>
      <td>10.1.10.1/30</td>
    </tr>
    <tr>
      <td>dc1-leaf-001</td>
      <td>Ethernet1/2</td>
      <td>dc1-spine-002_E1/1</td>
      <td>10.1.10.5/30</td>
    </tr>
    <tr>
      <td>dc1-leaf-002</td>
      <td>Ethernet1/1</td>
      <td>dc1-spine-001_E1/2</td>
      <td>10.1.10.9/30</td>
    </tr>
    <tr>
      <td>dc1-leaf-002</td>
      <td>Ethernet1/2</td>
      <td>dc1-spine-002_E1/2</td>
      <td>10.1.10.13/30</td>
    </tr>
    <tr>
      <td>dc1-leaf-003</td>
      <td>Ethernet1/1</td>
      <td>dc1-spine-001_E1/3</td>
      <td>10.1.10.17/30</td>
    </tr>
    <tr>
      <td>dc1-leaf-003</td>
      <td>Ethernet1/2</td>
      <td>dc1-spine-002_E1/3</td>
      <td>10.1.10.21/30</td>
    </tr>
    <tr>
      <td>dc1-leaf-004</td>
      <td>Ethernet1/1</td>
      <td>dc1-spine-001_E1/4</td>
      <td>10.1.10.25/30</td>
    </tr>
    <tr>
      <td>dc1-leaf-004</td>
      <td>Ethernet1/2</td>
      <td>dc1-spine-002_E1/4</td>
      <td>10.1.10.29/30</td>
    </tr>
  </tbody>
</table>

<h4 id="underlay-interfaces---spines">Underlay Interfaces - Spines</h4>

<table>
  <thead>
    <tr>
      <th>Hostname</th>
      <th>Interface</th>
      <th>Description</th>
      <th>IP Address</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>dc1-spine-001</td>
      <td>Ethernet1/1</td>
      <td>dc1-leaf-001_E1/1</td>
      <td>10.1.10.2/30</td>
    </tr>
    <tr>
      <td>dc1-spine-001</td>
      <td>Ethernet1/2</td>
      <td>dc1-leaf-002_E1/1</td>
      <td>10.1.10.10/30</td>
    </tr>
    <tr>
      <td>dc1-spine-001</td>
      <td>Ethernet1/3</td>
      <td>dc1-leaf-003_E1/1</td>
      <td>10.1.10.18/30</td>
    </tr>
    <tr>
      <td>dc1-spine-001</td>
      <td>Ethernet1/4</td>
      <td>dc1-leaf-004_E1/1</td>
      <td>10.1.10.26/30</td>
    </tr>
    <tr>
      <td>dc1-spine-002</td>
      <td>Ethernet1/1</td>
      <td>dc1-leaf-001_E1/2</td>
      <td>10.1.10.6/30</td>
    </tr>
    <tr>
      <td>dc1-spine-002</td>
      <td>Ethernet1/2</td>
      <td>dc1-leaf-002_E1/2</td>
      <td>10.1.10.14/30</td>
    </tr>
    <tr>
      <td>dc1-spine-002</td>
      <td>Ethernet1/3</td>
      <td>dc1-leaf-003_E1/2</td>
      <td>10.1.10.22/30</td>
    </tr>
    <tr>
      <td>dc1-spine-002</td>
      <td>Ethernet1/4</td>
      <td>dc1-leaf-004_E1/2</td>
      <td>10.1.10.30/30</td>
    </tr>
  </tbody>
</table>

<h1 id="ansible-overview-and-setup">Ansible Overview and Setup</h1>

<p>An overview of some of the ansible terminology I’ll refer to through this article:</p>

<ul>
  <li><strong>Tasks</strong>: A command executed against a host.</li>
  <li><strong>Playbooks</strong>: A sequence of commands executed against a host. We’ll use eight playbooks for our EVPN and VXLAN deployment.</li>
  <li><strong>Variables</strong>:  Configuration parameters that are unique to each host (e.g. Loopback0 address) are defined in variables, which can be defined in multiple places.  The playbooks we’ll use reference variables in the hosts (inventory file), host_vars and group_vars directories - see the directory structure below for an example.  You can read more on variables in the <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#ansible-variable-precedence">User Guide</a></li>
  <li><strong>Hosts File</strong>:  An inventory of devices that playbooks will be run against is defined in the <strong>hosts</strong> file.  Our hosts file will include two groups [spines] and [leafs].  Within the hosts file you can also define aliases and host vars.  Loopback addresses and hostnames for example.  Defining host specific variables in the hosts file soon becomes unwieldily to manage as the number of variables grow.  We’ll look at some alternatives - group_vars and host_vars below.</li>
  <li><strong>Collections</strong>: The <a href="https://docs.ansible.com/ansible/latest/collections/cisco/nxos/index.html#plugins-in-cisco-nxos">Cisco Nxos collection</a> will be used throughout our playbooks</li>
</ul>

<h4 id="pre-requisites">Pre-requisites</h4>

<ul>
  <li>Before running the playbooks, from console boot the NXOS image <code class="language-plaintext highlighter-rouge">loader &gt; boot nxos.9.3.7.bin</code> and assign the management addresses as defined in your hosts file.</li>
  <li>Install ansible - in my case <code class="language-plaintext highlighter-rouge">pip install ansible</code> inside a virtual environment.  See the <a href="https://docs.ansible.com/ansible/latest/installation_guide/intro_installation.html">Install Guide</a></li>
  <li>A working knowledge of EVPN and VXLAN on Nexus switches - recommend reading the <a href="https://www.cisco.com/c/en/us/products/collateral/switches/nexus-9000-series-switches/guide-c07-734107.html">design guide</a> for fundamentals</li>
</ul>

<p>An outline of the files and directory structure used for this project is shown below.</p>

<h5 id="project-and-directory-structure">Project and Directory Structure</h5>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>.
├── 1_global_configuration.yml
├── 2_configure_spines.yml
├── 3_configure_leafs.yml
├── 4_configure_bgp_evpn_spines.yml
├── 5_configure_bgp_evpn_leafs.yml
├── 6_configure_vxlan_leafs_tenant_1.yml
├── 7_configure_vxlan_leafs_tenant_2.yml
├── 8_verify_fabric.yml
├── Ansible_snapshot
├── ansible.cfg
├── configure_routes.yml
├── first_playbook.yml
├── group_vars
│   ├── leafs.yml
│   └── spines.yml
├── host_vars
│   ├── dc1-leaf-001
│   │   ├── interfaces.yml
│   │   └── vpc.yml
│   ├── dc1-leaf-002
│   │   ├── interfaces.yml
│   │   └── vpc.yml
│   ├── dc1-leaf-003
│   │   ├── interfaces.yml
│   │   └── vpc.yml
│   ├── dc1-leaf-004
│   │   ├── interfaces.yml
│   │   └── vpc.yml
│   ├── dc1-spine-001
│   │   ├── interfaces.yml
│   │   └── vpc.yml
│   └── dc1-spine-002
│       ├── interfaces.yml
│       └── vpc.yml
├── hosts
</code></pre></div></div>

<h2 id="ansible-configuration-file">Ansible configuration file</h2>
<p>Ansible configuration file is as default except for:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[defaults]
inventory = hosts
host_key_checking = false
record_host_key = true
stdout_callback = debug
ansible_python_interpreter=venv/bin/python3.9
</code></pre></div></div>

<h2 id="inventory-and-hosts-file">Inventory and Hosts file</h2>
<p>Create groups within your hosts file that makes sense for your environment.  In the case of our lab:</p>
<ul>
  <li>Groups are defined in [brackets], we define Spine, Leafs  as <code class="language-plaintext highlighter-rouge">[leafs] [spines]</code></li>
  <li>Under each group we define the Management address and hostname of member switches</li>
  <li>We define group specific variables (username and password) using the <code class="language-plaintext highlighter-rouge">[group:vars]</code> notation</li>
</ul>

<p>Here’s the complete hosts file we’ll use for our lab.  Edit the management addresses and credentials as needed.</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>[dc1:children]
spines
leafs
[dc1:vars]
ansible_become=yes
ansible_become_method=enable
ansible_network_os=nxos
ansible_user=admin
ansible_password=Cisco123!
ansible_python_interpreter=venv/bin/python3.9

[leafs]
dc1-leaf-001 ansible_host=192.168.200.113 hostname=dc1-leaf-001
dc1-leaf-002 ansible_host=192.168.200.114 hostname=dc1-leaf-002
dc1-leaf-003 ansible_host=192.168.200.115 hostname=dc1-leaf-003
dc1-leaf-004 ansible_host=192.168.200.116 hostname=dc1-leaf-004

[leafs:vars]
ansible_become=yes
ansible_become_method=enable
ansible_network_os=nxos
ansible_user=admin
ansible_password=Cisco123!
ansible_python_interpreter=venv/bin/python3.9


[spines]
dc1-spine-001 ansible_host=192.168.200.117 hostname=dc1-spine-001 loopback=10.1.1.101/32
dc1-spine-002 ansible_host=192.168.200.118 hostname=dc1-spine-002 loopback=10.1.1.102/32

[spines:vars]
ansible_become=yes
ansible_become_method=enable
ansible_network_os=nxos
ansible_user=admin
ansible_password=Cisco123!
ansible_python_interpreter=venv/bin/python3.9
</code></pre></div></div>

<h2 id="variables">Variables</h2>

<p>Variables define configuration items that are unique to each switch, loopback0 and underlay addresses for example.</p>

<p>Variables can be defined in multiple places, from the command line, role defaults, the inventory (hosts) file, group_vars and host_vars and from the playbook itself.</p>

<p>This also represents the high-level precedence that variables will be applied, for example a loopback0 address defined in the hosts file is preferred over a lopback0 variable defined in a host_vars folder.</p>

<p>To keep variable definitions manageable, use of hosts file for variables will be kept to a minimum. Instead we’ll define variables common to a group of switches in the <code class="language-plaintext highlighter-rouge">group_vars\'group-name'.yml</code> files and variables unique to each switch are defined under the <code class="language-plaintext highlighter-rouge">host_vars\ 'hostname'\'variable-file'.yml </code></p>

<p>Below shows the structure of files that will contain the variables for this deployment.</p>

<p>Refer to  Ansible Variable Documentation <a href="https://docs.ansible.com/ansible/latest/user_guide/playbooks_variables.html#playbooks-variables">here</a></p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>├── group_vars
│   ├── leafs.yml
│   └── spines.yml
├── host_vars
│   ├── dc1-leaf-001
│   │   ├── interfaces.yml
│   │   └── vpc.yml
│   ├── dc1-leaf-002
│   │   ├── interfaces.yml
│   │   └── vpc.yml
│   ├── dc1-leaf-003
│   │   ├── interfaces.yml
│   │   └── vpc.yml
│   ├── dc1-leaf-004
│   │   ├── interfaces.yml
│   │   └── vpc.yml
│   ├── dc1-spine-001
│   │   ├── interfaces.yml
│   │   └── vpc.yml
│   └── dc1-spine-002
│       ├── interfaces.yml
│       └── vpc.yml
├── hosts
</code></pre></div></div>

<h3 id="inventory-or-host-file-vars">Inventory or host file vars</h3>

<p>Only Management address and hostnames are defined here.</p>

<h3 id="host-vars">Host vars</h3>
<p>The host_vars folder will contain a folder for each device, the folder name is the same as the hostname defined in our hosts file.  Interface addressing, router-ids and spine rp-addresses are defined here.</p>

<p>Sample  <strong>interfaces.yml</strong> hosts_vars file for <strong>Leafs</strong>:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">loopback0</span><span class="pi">:</span> <span class="s">10.1.1.1/32</span>
<span class="na">loopback1</span><span class="pi">:</span> <span class="s">10.1.1.111/32</span>
<span class="na">router_id</span><span class="pi">:</span> <span class="s">10.1.1.1</span>
<span class="na">eth1</span><span class="pi">:</span> <span class="s">10.1.10.1/30</span>
<span class="na">eth2</span><span class="pi">:</span> <span class="s">10.1.10.5/30</span>
<span class="na">access_vlan</span><span class="pi">:</span> <span class="m">10</span>

<span class="na">L3_interfaces</span><span class="pi">:</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">Ethernet1/1</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-spine-001_Ethernet1/1</span> <span class="pi">}</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">Ethernet1/2</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-spine-002_Ethernet1/1</span> <span class="pi">}</span>

<span class="na">L3_loopbacks</span><span class="pi">:</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">loopback0</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">RID and Update Source</span> <span class="pi">}</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">loopback1</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Anycast RP</span> <span class="pi">}</span>

<span class="na">Underlay_interfaces</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">underlay_int</span><span class="pi">:</span> <span class="nv">Ethernet1/1</span><span class="pi">,</span> <span class="nv">underlay_addr</span><span class="pi">:</span> <span class="nv">10.1.10.1/30</span><span class="pi">,</span> <span class="nv">underlay_descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-spine-001_Ethernet1/1</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">underlay_int</span><span class="pi">:</span> <span class="nv">Ethernet1/2</span><span class="pi">,</span> <span class="nv">underlay_addr</span><span class="pi">:</span> <span class="nv">10.1.10.5/30</span><span class="pi">,</span> <span class="nv">underlay_descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-spine-002_Ethernet1/1</span> <span class="pi">}</span>

<span class="na">Lag_interfaces</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">lag_name</span><span class="pi">:</span> <span class="nv">port-channel1</span><span class="pi">,</span> <span class="nv">lag_member</span><span class="pi">:</span> <span class="nv">Ethernet1/3</span><span class="pi">,</span> <span class="nv">lag_mode</span><span class="pi">:</span> <span class="nv">active</span><span class="pi">}</span>

<span class="na">rp_address</span><span class="pi">:</span> <span class="s">10.1.1.200</span>
<span class="na">s1_loopback</span><span class="pi">:</span> <span class="s">10.1.1.101</span>
<span class="na">s2_loopback</span><span class="pi">:</span> <span class="s">10.1.1.102</span>
</code></pre></div></div>

<p>Sample  <strong>interfaces.yml</strong> hosts_vars file for <strong>Spines</strong>:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">loopback0</span><span class="pi">:</span> <span class="s">10.1.1.101/32</span>
<span class="na">loopback1</span><span class="pi">:</span> <span class="s">10.1.1.200/32</span>
<span class="na">router_id</span><span class="pi">:</span> <span class="s">10.1.1.101</span>
<span class="na">eth1</span><span class="pi">:</span> <span class="s">10.1.10.2/30</span>
<span class="na">eth2</span><span class="pi">:</span> <span class="s">10.1.10.10/30</span>
<span class="na">eth3</span><span class="pi">:</span> <span class="s">10.1.10.18/30</span>
<span class="na">eth4</span><span class="pi">:</span> <span class="s">10.1.10.26/30</span>


<span class="na">L3_interfaces</span><span class="pi">:</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">Ethernet1/1</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-001_Ethernet1/1</span> <span class="pi">}</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">Ethernet1/2</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-002_Ethernet1/1</span> <span class="pi">}</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">Ethernet1/3</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-003_Ethernet1/1</span> <span class="pi">}</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">Ethernet1/4</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-004_Ethernet1/1</span> <span class="pi">}</span>

<span class="na">L3_loopbacks</span><span class="pi">:</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">loopback0</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">RID and Update Source</span> <span class="pi">}</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">loopback1</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Anycast RP</span> <span class="pi">}</span>

<span class="na">Underlay_interfaces</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">underlay_int</span><span class="pi">:</span> <span class="nv">Ethernet1/1</span><span class="pi">,</span> <span class="nv">underlay_addr</span><span class="pi">:</span> <span class="nv">10.1.10.2/30</span><span class="pi">,</span> <span class="nv">underlay_descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-001_Ethernet1/1</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">underlay_int</span><span class="pi">:</span> <span class="nv">Ethernet1/2</span><span class="pi">,</span> <span class="nv">underlay_addr</span><span class="pi">:</span> <span class="nv">10.1.10.10/30</span><span class="pi">,</span> <span class="nv">underlay_descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-002_Ethernet1/1</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">underlay_int</span><span class="pi">:</span> <span class="nv">Ethernet1/3</span><span class="pi">,</span> <span class="nv">underlay_addr</span><span class="pi">:</span> <span class="nv">10.1.10.18/30</span><span class="pi">,</span> <span class="nv">underlay_descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-003_Ethernet1/1</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">underlay_int</span><span class="pi">:</span> <span class="nv">Ethernet1/4</span><span class="pi">,</span> <span class="nv">underlay_addr</span><span class="pi">:</span> <span class="nv">10.1.10.26/30</span><span class="pi">,</span> <span class="nv">underlay_descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-004_Ethernet1/1</span> <span class="pi">}</span>

<span class="na">loopback1_rp</span><span class="pi">:</span> <span class="s">10.1.1.200</span>
<span class="na">s1_loopback</span><span class="pi">:</span> <span class="s">10.1.1.101</span>
<span class="na">s2_loopback</span><span class="pi">:</span> <span class="s">10.1.1.102</span>
</code></pre></div></div>

<h3 id="group-vars">Group vars</h3>

<p>The group_vars contains configuration common to all leaves.  For our deployment, we define the BGP AS and nieghbours, tenant VLAN IDs and VNIDs, SVI addresses and multicast groups here.</p>

<p><strong>group_vars/leafs.yml</strong> file:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code> <span class="na">asn</span><span class="pi">:</span> <span class="m">65000</span>

<span class="na">bgp_neighbors</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">remote_as</span><span class="pi">:</span> <span class="nv">65000</span><span class="pi">,</span> <span class="nv">neighbor</span><span class="pi">:</span> <span class="nv">10.1.1.101</span><span class="pi">,</span> <span class="nv">update_source</span><span class="pi">:</span> <span class="nv">Loopback0</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">remote_as</span><span class="pi">:</span> <span class="nv">65000</span><span class="pi">,</span> <span class="nv">neighbor</span><span class="pi">:</span> <span class="nv">10.1.1.102</span><span class="pi">,</span> <span class="nv">update_source</span><span class="pi">:</span> <span class="nv">Loopback0</span> <span class="pi">}</span>

<span class="na">L2VNI_Tenant1</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">10</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50010</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.10.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-10-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.10</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">11</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50011</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.11.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-11-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.11</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">12</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50012</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.12.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-12-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.12</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">13</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50013</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.13.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-13-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.13</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">14</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50014</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.14.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-14-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.14</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">15</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50015</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.15.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-15-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.15</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">16</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50016</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.16.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-16-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.16</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">17</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50017</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.17.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-17-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.17</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">18</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50018</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.18.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-18-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.18</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">19</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50019</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.19.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-19-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.19</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">20</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50020</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.20.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-20-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.20</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">21</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50021</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.21.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-21-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.21</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">22</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50022</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.22.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-22-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.22</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">23</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50023</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.23.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-23-Tenant1</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.23</span> <span class="pi">}</span>

<span class="na">L2VNI_Tenant2</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">110</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50110</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.110.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-110-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.110</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">111</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50111</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.111.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-111-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.111</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">112</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50112</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.112.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-112-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.112</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">113</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50113</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.113.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-113-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.113</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">114</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50114</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.114.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-114-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.114</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">115</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50115</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.115.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-115-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.115</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">116</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50116</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.116.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-116-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.116</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">117</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50117</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.117.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-117-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.117</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">118</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50118</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.118.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-118-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.118</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">119</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50119</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.119.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-119-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.119</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">120</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50120</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.120.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-120-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.120</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">121</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50121</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.121.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-121-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.121</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">122</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50122</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.122.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-122-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.122</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">123</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50123</span><span class="pi">,</span> <span class="nv">ip_add</span><span class="pi">:</span> <span class="nv">10.1.123.1/24</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L2-VNI-123-Tenant2</span><span class="pi">,</span> <span class="nv">mcast</span><span class="pi">:</span> <span class="nv">239.0.0.123</span> <span class="pi">}</span>

<span class="na">L3VNI_Tenant1</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">999</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L3-VNI-999-Tenant1</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">50999</span> <span class="pi">}</span>
<span class="na">L3VNI_Tenant2</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">vlan_id</span><span class="pi">:</span> <span class="nv">1000</span><span class="pi">,</span> <span class="nv">vlan_name</span><span class="pi">:</span> <span class="nv">L3-VNI-1000-Tenant2</span><span class="pi">,</span> <span class="nv">vni</span><span class="pi">:</span> <span class="nv">51000</span> <span class="pi">}</span>
</code></pre></div></div>
<p><strong>group_vars/spines.yml</strong> file:</p>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="na">loopback0</span><span class="pi">:</span> <span class="s">10.1.1.102/32</span>
<span class="na">loopback1</span><span class="pi">:</span> <span class="s">10.1.1.200/32</span>
<span class="na">router_id</span><span class="pi">:</span> <span class="s">10.1.1.102</span>
<span class="na">eth1</span><span class="pi">:</span> <span class="s">10.1.10.6/30</span>
<span class="na">eth2</span><span class="pi">:</span> <span class="s">10.1.10.14/30</span>
<span class="na">eth3</span><span class="pi">:</span> <span class="s">10.1.10.22/30</span>
<span class="na">eth4</span><span class="pi">:</span> <span class="s">10.1.10.30/30</span>

<span class="na">L3_interfaces</span><span class="pi">:</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">Ethernet1/1</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-001_Ethernet1/2</span> <span class="pi">}</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">Ethernet1/2</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-002_Ethernet1/2</span> <span class="pi">}</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">Ethernet1/3</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-003_Ethernet1/2</span> <span class="pi">}</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">Ethernet1/4</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-004_Ethernet1/2</span> <span class="pi">}</span>

<span class="na">L3_loopbacks</span><span class="pi">:</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">loopback0</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">RID and Update Source</span> <span class="pi">}</span>
<span class="pi">-</span> <span class="pi">{</span> <span class="nv">interface</span><span class="pi">:</span> <span class="nv">loopback1</span><span class="pi">,</span> <span class="nv">descr</span><span class="pi">:</span> <span class="nv">Anycast RP</span> <span class="pi">}</span>

<span class="na">Underlay_interfaces</span><span class="pi">:</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">underlay_int</span><span class="pi">:</span> <span class="nv">Ethernet1/1</span><span class="pi">,</span> <span class="nv">underlay_addr</span><span class="pi">:</span> <span class="nv">10.1.10.6/30</span><span class="pi">,</span> <span class="nv">underlay_descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-001_Ethernet1/2</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">underlay_int</span><span class="pi">:</span> <span class="nv">Ethernet1/2</span><span class="pi">,</span> <span class="nv">underlay_addr</span><span class="pi">:</span> <span class="nv">10.1.10.14/30</span><span class="pi">,</span> <span class="nv">underlay_descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-002_Ethernet1/2</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">underlay_int</span><span class="pi">:</span> <span class="nv">Ethernet1/3</span><span class="pi">,</span> <span class="nv">underlay_addr</span><span class="pi">:</span> <span class="nv">10.1.10.22/30</span><span class="pi">,</span> <span class="nv">underlay_descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-003_Ethernet1/2</span> <span class="pi">}</span>
  <span class="pi">-</span> <span class="pi">{</span> <span class="nv">underlay_int</span><span class="pi">:</span> <span class="nv">Ethernet1/4</span><span class="pi">,</span> <span class="nv">underlay_addr</span><span class="pi">:</span> <span class="nv">10.1.10.30/30</span><span class="pi">,</span> <span class="nv">underlay_descr</span><span class="pi">:</span> <span class="nv">Underlay_dc1-leaf-004_Ethernet1/2</span> <span class="pi">}</span>

<span class="na">loopback1_rp</span><span class="pi">:</span> <span class="s">10.1.1.200</span>
<span class="na">s1_loopback</span><span class="pi">:</span> <span class="s">10.1.1.101</span>
<span class="na">s2_loopback</span><span class="pi">:</span> <span class="s">10.1.1.102</span>
</code></pre></div></div>

<h2 id="playbooks">Playbooks</h2>

<h3 id="1-global-configuration-playbook">(1) Global Configuration Playbook</h3>

<p>In the global configuration playbook we define base configuration tasks that are common to all switches:</p>
<ol>
  <li>Create a snapshop of the current Configuration</li>
  <li>Configure device hostnames as defined in the hosts file</li>
  <li>Enable the BGP, OSPF, Interface-VLAN, EVPN and VXLAN Features</li>
  <li>Create loopback0 interface</li>
  <li>Enable the OSPF process</li>
</ol>

<p>Running the playbook:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-playbook <span class="nt">-i</span> hosts <span class="nt">-c</span> ansible.netcommon.network_cli 1_global_configuration.yml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Network Getting Started First Playbook Extended</span>
  <span class="na">connection</span><span class="pi">:</span> <span class="s">ansible.netcommon.network_cli</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">all</span>
  <span class="na">tasks</span><span class="pi">:</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create snapshot</span>
      <span class="na">nxos_snapshot</span><span class="pi">:</span>
        <span class="na">action</span><span class="pi">:</span> <span class="s">create</span>
        <span class="na">snapshot_name</span><span class="pi">:</span> <span class="s">Ansible_snapshot</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Done with Ansible</span>
        <span class="na">save_snapshot_locally</span><span class="pi">:</span> <span class="no">true</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">remove configuration</span>
      <span class="na">nxos_system</span><span class="pi">:</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">absent</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">configure hostname and domain-name</span>
      <span class="na">nxos_system</span><span class="pi">:</span>
        <span class="na">hostname</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">hostname</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">domain_name</span><span class="pi">:</span> <span class="s">test.example.com</span>


    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">configure name servers</span>
      <span class="na">nxos_system</span><span class="pi">:</span>
        <span class="na">name_servers</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">8.8.8.8</span>
          <span class="pi">-</span> <span class="s">8.8.4.4</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">configure name servers with VRF support</span>
      <span class="na">nxos_system</span><span class="pi">:</span>
        <span class="na">name_servers</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="pi">{</span> <span class="nv">server</span><span class="pi">:</span> <span class="nv">8.8.8.8</span><span class="pi">,</span> <span class="nv">vrf</span><span class="pi">:</span> <span class="nv">management</span> <span class="pi">}</span>
          <span class="pi">-</span> <span class="pi">{</span> <span class="nv">server</span><span class="pi">:</span> <span class="nv">8.8.4.4</span><span class="pi">,</span> <span class="nv">vrf</span><span class="pi">:</span> <span class="nv">management</span> <span class="pi">}</span>


    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ensure BGP is enabled</span>
      <span class="na">nxos_feature</span><span class="pi">:</span>
        <span class="na">feature</span><span class="pi">:</span> <span class="s">bgp</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">enabled</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ensure ospf is enabled</span>
      <span class="na">nxos_feature</span><span class="pi">:</span>
        <span class="na">feature</span><span class="pi">:</span> <span class="s">ospf</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">enabled</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ensure Interface VLAN is enabled</span>
      <span class="na">nxos_feature</span><span class="pi">:</span>
        <span class="na">feature</span><span class="pi">:</span> <span class="s">interface-vlan</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">enabled</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ensure PIM is enabled</span>
      <span class="na">nxos_feature</span><span class="pi">:</span>
        <span class="na">feature</span><span class="pi">:</span> <span class="s">pim</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">enabled</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ensure VN Segment is enabled</span>
      <span class="na">nxos_feature</span><span class="pi">:</span>
        <span class="na">feature</span><span class="pi">:</span> <span class="s">vn-segment-vlan-based</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">enabled</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ensure NV Overlay is enabled</span>
      <span class="na">nxos_feature</span><span class="pi">:</span>
        <span class="na">feature</span><span class="pi">:</span> <span class="s">nv overlay</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">enabled</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable EVPN Control Plane</span>
      <span class="na">nxos_evpn_global</span><span class="pi">:</span>
        <span class="na">nv_overlay_evpn</span><span class="pi">:</span> <span class="no">true</span>


    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Merge provided configuration with device configuration.</span>
      <span class="na">nxos_l3_interfaces</span><span class="pi">:</span>
        <span class="na">config</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">loopback0</span>
          <span class="na">ipv4</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">loopback0</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">merged</span>


    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create OSPF instance</span>
      <span class="na">nxos_ospf</span><span class="pi">:</span>
        <span class="na">ospf</span><span class="pi">:</span> <span class="m">1</span>
        <span class="na">state</span><span class="pi">:</span> <span class="s">present</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable OSPF on interface</span>
      <span class="s">cisco.nxos.nxos_ospf_interfaces</span><span class="pi">:</span>
        <span class="na">config</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">loopback0</span>
            <span class="na">address_family</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">afi</span><span class="pi">:</span> <span class="s">ipv4</span>
              <span class="na">processes</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">process_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
                <span class="na">area</span><span class="pi">:</span>
                  <span class="na">area_id</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
                  <span class="na">secondaries</span><span class="pi">:</span> <span class="s">False</span>
                  
</code></pre></div></div>

<h3 id="2-spines-playbook">(2) Spines Playbook</h3>

<p>The Configure Spines Playbook:</p>
<ol>
  <li>Creates the global BGP routing process and iBGP neighbours for VTEP reachability</li>
  <li>Creates the loopback1 interface for multicast routing, PIM interfaces and RP-addresses</li>
  <li>COnfigures the underlay interfaces and IP addresses</li>
  <li>Enables OSPF on these interfaces</li>
</ol>

<p>Running the playbook:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-playbook <span class="nt">-i</span> hosts <span class="nt">-c</span> ansible.netcommon.network_cli 2_configure_spines.yml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>
  
<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configuring Spine Switches</span>
  <span class="na">connection</span><span class="pi">:</span> <span class="s">ansible.netcommon.network_cli</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">spines</span>
  <span class="na">tasks</span><span class="pi">:</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure Leaf iBGP neighbours</span>
    <span class="s">cisco.nxos.nxos_bgp_global</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="na">as_number</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">asn</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">router_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">router_id</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">log_neighbor_changes</span><span class="pi">:</span> <span class="s">True</span>
        <span class="na">neighbors</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">neighbor_address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.neighbor</span><span class="nv"> </span><span class="s">}}"</span>
            <span class="na">remote_as</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.remote_as</span><span class="nv"> </span><span class="s">}}"</span>
            <span class="na">description</span><span class="pi">:</span> <span class="s">Leaf iBGP Neighbours</span>
            <span class="na">update_source</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.update_source</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">bgp_neighbors</span><span class="nv"> </span><span class="s">}}"</span>


  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure iBGP neighbor AF</span>
    <span class="s">cisco.nxos.nxos_bgp_neighbor_address_family</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="na">as_number</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">asn</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">neighbors</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">neighbor_address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.neighbor</span><span class="nv"> </span><span class="s">}}"</span>
            <span class="na">address_family</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">afi</span><span class="pi">:</span> <span class="s">ipv4</span>
                <span class="na">safi</span><span class="pi">:</span> <span class="s">unicast</span>
                <span class="na">route_reflector_client</span><span class="pi">:</span> <span class="s">yes</span>
                <span class="na">send_community</span><span class="pi">:</span>
                  <span class="na">both</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">bgp_neighbors</span><span class="nv"> </span><span class="s">}}"</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create Loopback1 Interface</span>
    <span class="na">nxos_l3_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">loopback1</span>
        <span class="na">ipv4</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">loopback1</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_interfaces}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">Underlay</span>


  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create Layer 3 Interfaces</span>
    <span class="na">nxos_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.interface</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.descr</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">mode</span><span class="pi">:</span> <span class="s">layer3</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">merged</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_interfaces}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">multicast</span>


  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set interface IPv4 address on underlay</span>
    <span class="na">nxos_l3_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.underlay_int</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">ipv4</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.underlay_addr</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{Underlay_interfaces}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">Underlay</span>



  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create Anycast RP interface</span>
    <span class="s">cisco.nxos.nxos_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">loopback1</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Anycast RP interface</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">merged</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure PIM Loopbacks</span>
    <span class="na">nxos_pim_interface</span><span class="pi">:</span>
      <span class="na">interface</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.interface</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="na">sparse</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_loopbacks}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">multicast</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure PIM int</span>
    <span class="na">nxos_pim_interface</span><span class="pi">:</span>
      <span class="na">interface</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.interface</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="na">sparse</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_interfaces}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">multicast</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable OSPF on interface</span>
    <span class="s">cisco.nxos.nxos_ospf_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.interface</span><span class="nv"> </span><span class="s">}}"</span>
          <span class="na">address_family</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">afi</span><span class="pi">:</span> <span class="s">ipv4</span>
            <span class="na">processes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">process_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
              <span class="na">area</span><span class="pi">:</span>
                <span class="na">area_id</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
                <span class="na">secondaries</span><span class="pi">:</span> <span class="s">False</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_interfaces}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">ospf</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable OSPF on Lo1</span>
    <span class="s">cisco.nxos.nxos_ospf_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.interface</span><span class="nv"> </span><span class="s">}}"</span>
          <span class="na">address_family</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">afi</span><span class="pi">:</span> <span class="s">ipv4</span>
            <span class="na">processes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">process_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
              <span class="na">area</span><span class="pi">:</span>
                <span class="na">area_id</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
                <span class="na">secondaries</span><span class="pi">:</span> <span class="s">False</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_loopbacks}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">ospf</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure PIM RP</span>
    <span class="na">nxos_pim_rp_address</span><span class="pi">:</span>
      <span class="na">rp_address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">loopback1_rp</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">multicast</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure Anycast RP</span>
    <span class="na">nxos_config</span><span class="pi">:</span>
      <span class="na">lines</span><span class="pi">:</span>
       <span class="pi">-</span> <span class="s2">"</span><span class="s">ip</span><span class="nv"> </span><span class="s">pim</span><span class="nv"> </span><span class="s">anycast-rp</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">loopback1_rp</span><span class="nv"> </span><span class="s">}}</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">s1_loopback</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="pi">-</span> <span class="s2">"</span><span class="s">ip</span><span class="nv"> </span><span class="s">pim</span><span class="nv"> </span><span class="s">anycast-rp</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">loopback1_rp}}</span><span class="nv"> </span><span class="s">{{</span><span class="nv"> </span><span class="s">s2_loopback</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">multicast</span>
    
</code></pre></div></div>

<h3 id="3-leafs-playbook">(3) Leafs Playbook</h3>

<p>The Configure Leafs Playbook:</p>
<ol>
  <li>Creates the global BGP routing process and iBGP neighbours for VTEP reachability</li>
  <li>Creates the loopback1 interface for multicast routing, PIM interfaces and RP-addresses</li>
  <li>Configures the underlay interfaces and IP addresses</li>
  <li>Enables OSPF on these interfaces</li>
  <li>Configures the Access Interface E1/5 which connects to the Ubuntu hosts used in our lab</li>
</ol>

<p>Running the playbook:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-playbook <span class="nt">-i</span> hosts <span class="nt">-c</span> ansible.netcommon.network_cli 3_configure_leafs.yml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configuring Leaf Switches</span>
  <span class="na">connection</span><span class="pi">:</span> <span class="s">ansible.netcommon.network_cli</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">leafs</span>
  <span class="na">tasks</span><span class="pi">:</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Merge provided configuration with device configuration.</span>
    <span class="na">nxos_l3_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">loopback1</span>
        <span class="na">ipv4</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">loopback1</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_interfaces}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">Underlay</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create Layer 3 Interfaces</span>
    <span class="na">nxos_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.interface</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.descr</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">mode</span><span class="pi">:</span> <span class="s">layer3</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">merged</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_interfaces}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">multicast</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable OSPF on interface</span>
    <span class="s">cisco.nxos.nxos_ospf_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.interface</span><span class="nv"> </span><span class="s">}}"</span>
          <span class="na">address_family</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">afi</span><span class="pi">:</span> <span class="s">ipv4</span>
            <span class="na">processes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">process_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
              <span class="na">area</span><span class="pi">:</span>
                <span class="na">area_id</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
                <span class="na">secondaries</span><span class="pi">:</span> <span class="s">False</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_interfaces}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">ospf</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable OSPF on Lo1</span>
    <span class="s">cisco.nxos.nxos_ospf_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.interface</span><span class="nv"> </span><span class="s">}}"</span>
          <span class="na">address_family</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">afi</span><span class="pi">:</span> <span class="s">ipv4</span>
            <span class="na">processes</span><span class="pi">:</span>
            <span class="pi">-</span> <span class="na">process_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">1"</span>
              <span class="na">area</span><span class="pi">:</span>
                <span class="na">area_id</span><span class="pi">:</span> <span class="s">0.0.0.0</span>
                <span class="na">secondaries</span><span class="pi">:</span> <span class="s">False</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_loopbacks}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">ospf</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set interface IPv4 address on underlay</span>
    <span class="na">nxos_l3_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.underlay_int</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">ipv4</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.underlay_addr</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{Underlay_interfaces}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">Underlay</span>


  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure Access Interfaces</span>
    <span class="s">cisco.nxos.nxos_l2_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Ethernet1/5</span>
        <span class="na">mode</span><span class="pi">:</span> <span class="s">access</span>
        <span class="na">access</span><span class="pi">:</span>
          <span class="na">vlan</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{access_vlan}}"</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">merged</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable PIM</span>
    <span class="na">nxos_feature</span><span class="pi">:</span>
      <span class="na">feature</span><span class="pi">:</span> <span class="s">pim</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">enabled</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">multicast</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Create Anycast RP interface</span>
    <span class="s">cisco.nxos.nxos_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">loopback1</span>
        <span class="na">description</span><span class="pi">:</span> <span class="s">Anycast RP interface</span>
        <span class="na">enabled</span><span class="pi">:</span> <span class="no">true</span>
      <span class="na">state</span><span class="pi">:</span> <span class="s">merged</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Merge provided configuration with device configuration.</span>
    <span class="na">nxos_l3_interfaces</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">loopback1</span>
        <span class="na">ipv4</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">loopback1</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_interfaces}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">Underlay</span>


  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure PIM int</span>
    <span class="na">nxos_pim_interface</span><span class="pi">:</span>
      <span class="na">interface</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.interface</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="na">sparse</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_interfaces}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">multicast</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure PIM Loopbacks</span>
    <span class="na">nxos_pim_interface</span><span class="pi">:</span>
      <span class="na">interface</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.interface</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="na">sparse</span><span class="pi">:</span> <span class="no">true</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L3_loopbacks}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">multicast</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure PIM RP</span>
    <span class="na">nxos_pim_rp_address</span><span class="pi">:</span>
      <span class="na">rp_address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">rp_address</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">tags</span><span class="pi">:</span> <span class="s">multicast</span>

  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure Leaf iBGP neighbours</span>
    <span class="s">cisco.nxos.nxos_bgp_global</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="na">as_number</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">asn</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">router_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">router_id</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">log_neighbor_changes</span><span class="pi">:</span> <span class="s">True</span>
        <span class="na">neighbors</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">neighbor_address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.neighbor</span><span class="nv"> </span><span class="s">}}"</span>
            <span class="na">remote_as</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.remote_as</span><span class="nv"> </span><span class="s">}}"</span>
            <span class="na">description</span><span class="pi">:</span> <span class="s">Leaf iBGP Neighbours</span>
            <span class="na">update_source</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.update_source</span><span class="nv"> </span><span class="s">}}"</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">bgp_neighbors</span><span class="nv"> </span><span class="s">}}"</span>


  <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure iBGP neighbor AF</span>
    <span class="s">cisco.nxos.nxos_bgp_neighbor_address_family</span><span class="pi">:</span>
      <span class="na">config</span><span class="pi">:</span>
        <span class="na">as_number</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">asn</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">neighbors</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="na">neighbor_address</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.neighbor</span><span class="nv"> </span><span class="s">}}"</span>
            <span class="na">address_family</span><span class="pi">:</span>
              <span class="pi">-</span> <span class="na">afi</span><span class="pi">:</span> <span class="s">ipv4</span>
                <span class="na">safi</span><span class="pi">:</span> <span class="s">unicast</span>
                <span class="na">route_reflector_client</span><span class="pi">:</span> <span class="s">yes</span>
                <span class="na">send_community</span><span class="pi">:</span>
                  <span class="na">both</span><span class="pi">:</span> <span class="s">yes</span>
    <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">bgp_neighbors</span><span class="nv"> </span><span class="s">}}"</span>
    
</code></pre></div></div>

<h3 id="4-bgp-evpn-spines-playbook">(4) BGP EVPN Spines Playbook</h3>

<p>BGP EVPN Spines Playbook:</p>
<ol>
  <li>Creates the EVPN BGP Address Family</li>
  <li>Configure Route Reflector Clients</li>
</ol>

<p>Running the playbook:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-playbook <span class="nt">-i</span> hosts <span class="nt">-c</span> ansible.netcommon.network_cli 4_configure_bgp_evpn_spines.yml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configuring Leaf Switches</span>
  <span class="na">connection</span><span class="pi">:</span> <span class="s">ansible.netcommon.network_cli</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">spines</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure BGP EVPN</span>
      <span class="na">nxos_bgp_af</span><span class="pi">:</span>
       <span class="na">asn</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">asn</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">afi</span><span class="pi">:</span> <span class="s">l2vpn</span>
       <span class="na">safi</span><span class="pi">:</span> <span class="s">evpn</span>
      <span class="na">tags</span><span class="pi">:</span> <span class="s">evpn</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure iBGP neighbor EVPN AF</span>
      <span class="na">nxos_bgp_neighbor_af</span><span class="pi">:</span>
       <span class="na">asn</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">asn</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">neighbor</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.neighbor</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">afi</span><span class="pi">:</span> <span class="s">l2vpn</span>
       <span class="na">safi</span><span class="pi">:</span> <span class="s">evpn</span>
       <span class="na">route_reflector_client</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
       <span class="na">send_community</span><span class="pi">:</span> <span class="s">both</span>
      <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">bgp_neighbors</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="na">tags</span><span class="pi">:</span> <span class="s">evpn</span>
      
</code></pre></div></div>

<h3 id="5-bgp-evpn-leafs-playbook">(5) BGP EVPN Leafs Playbook</h3>

<p>BGP EVPN Leafs Playbook:</p>
<ol>
  <li>Creates the EVPN BGP Address Family</li>
  <li>Configure Spines as Neighbours</li>
  <li>Iterate over the list of VLANs in the <strong>leafs.yml</strong> file in group_vars and define the EVPN VNI</li>
</ol>

<p>Running the playbook:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-playbook <span class="nt">-i</span> hosts <span class="nt">-c</span> ansible.netcommon.network_cli 5_configure_bgp_evpn_leafs.yml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configuring Leaf Switches</span>
  <span class="na">connection</span><span class="pi">:</span> <span class="s">ansible.netcommon.network_cli</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">leafs</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure BGP EVPN</span>
      <span class="na">nxos_bgp_af</span><span class="pi">:</span>
       <span class="na">asn</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">asn</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">afi</span><span class="pi">:</span> <span class="s">l2vpn</span>
       <span class="na">safi</span><span class="pi">:</span> <span class="s">evpn</span>
      <span class="na">tags</span><span class="pi">:</span> <span class="s">evpn</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure iBGP neighbor EVPN AF</span>
      <span class="na">nxos_bgp_neighbor_af</span><span class="pi">:</span>
       <span class="na">asn</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">asn</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">neighbor</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.neighbor</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">afi</span><span class="pi">:</span> <span class="s">l2vpn</span>
       <span class="na">safi</span><span class="pi">:</span> <span class="s">evpn</span>
       <span class="na">send_community</span><span class="pi">:</span> <span class="s">both</span>
      <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">bgp_neighbors</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="na">tags</span><span class="pi">:</span> <span class="s">evpn</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L2VNI_Tenant2 RD/RT</span>
      <span class="na">nxos_evpn_vni</span><span class="pi">:</span>
       <span class="na">vni</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.vni</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">route_distinguisher</span><span class="pi">:</span> <span class="s">auto</span>
       <span class="na">route_target_both</span><span class="pi">:</span> <span class="s">auto</span>
      <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant2</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="na">tags</span><span class="pi">:</span> <span class="s">evpn</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L2VNI_Tenant1 RD/RT</span>
      <span class="na">nxos_evpn_vni</span><span class="pi">:</span>
       <span class="na">vni</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.vni</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">route_distinguisher</span><span class="pi">:</span> <span class="s">auto</span>
       <span class="na">route_target_both</span><span class="pi">:</span> <span class="s">auto</span>
      <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant1</span><span class="nv"> </span><span class="s">}}"</span>
      <span class="na">tags</span><span class="pi">:</span> <span class="s">evpn</span>
      
</code></pre></div></div>

<h3 id="6-tenant-1-vxlan-playbook">(6) Tenant-1 VXLAN Playbook</h3>

<p>In Playbooks 6 and 7, we define the VLAN to VNI mapping, interface VLANs and IP Addressing and create the NVE interface or VTEP tunnel on each leaf used for our two example Tenants “Tenant-1” and “Tenant-2”.</p>

<p>Running the playbook:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-playbook <span class="nt">-i</span> hosts <span class="nt">-c</span> ansible.netcommon.network_cli 6_configure_vxlan_leafs_tenant_1.yml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configuring Leaf Switches</span>
  <span class="na">connection</span><span class="pi">:</span> <span class="s">ansible.netcommon.network_cli</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">leafs</span>
  <span class="na">tasks</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable VXLAN Feature</span>
     <span class="na">nxos_feature</span><span class="pi">:</span>
       <span class="na">feature</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">state</span><span class="pi">:</span> <span class="s">enabled</span>
     <span class="na">with_items</span><span class="pi">:</span>
      <span class="pi">-</span> <span class="s">nv overlay</span>
      <span class="pi">-</span> <span class="s">vn-segment-vlan-based</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Enable NV Overlay</span>
     <span class="na">nxos_evpn_global</span><span class="pi">:</span>
       <span class="na">nv_overlay_evpn</span><span class="pi">:</span> <span class="no">true</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure VLAN to VNI</span>
     <span class="na">nxos_vlan</span><span class="pi">:</span>
       <span class="na">vlan_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.vlan_id</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">mapped_vni</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.vni</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.vlan_name</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">with_items</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant1</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L3VNI_Tenant1</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure Tenant VRF</span>
     <span class="na">nxos_vrf</span><span class="pi">:</span>
       <span class="na">vrf</span><span class="pi">:</span> <span class="s">Tenant-1</span>
       <span class="na">rd</span><span class="pi">:</span>  <span class="s">auto</span>
       <span class="na">vni</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L3VNI_Tenant1[0].vni</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure VRF AF</span>
     <span class="na">nxos_vrf_af</span><span class="pi">:</span>
       <span class="na">vrf</span><span class="pi">:</span> <span class="s">Tenant-1</span>
       <span class="na">route_target_both_auto_evpn</span><span class="pi">:</span> <span class="no">true</span>
       <span class="na">afi</span><span class="pi">:</span> <span class="s">ipv4</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure Anycast GW</span>
     <span class="na">nxos_overlay_global</span><span class="pi">:</span>
       <span class="na">anycast_gateway_mac</span><span class="pi">:</span> <span class="s">0000.2222.3333</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L2VNI_Tenant1</span>
     <span class="na">nxos_interface</span><span class="pi">:</span>
       <span class="na">interface</span><span class="pi">:</span> <span class="s">vlan"{{ item.vlan_id }}"</span>
     <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant1</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L3VNI_Tenant1</span>
     <span class="na">nxos_interface</span><span class="pi">:</span>
       <span class="na">interface</span><span class="pi">:</span> <span class="s">vlan"{{ L3VNI_Tenant1[0].vlan_id }}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Assign interface to Tenant VRF</span>
     <span class="na">nxos_vrf_interface</span><span class="pi">:</span>
       <span class="na">vrf</span><span class="pi">:</span> <span class="s">Tenant-1</span>
       <span class="na">interface</span><span class="pi">:</span> <span class="s2">"</span><span class="s">vlan{{</span><span class="nv"> </span><span class="s">item.vlan_id</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">with_items</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant1</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L3VNI_Tenant1</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>



   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set interface IPv4 address on underlay</span>
     <span class="na">nxos_l3_interface</span><span class="pi">:</span>
       <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">vlan{{</span><span class="nv"> </span><span class="s">item.vlan_id</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">ipv4</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.ip_add</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L2VNI_Tenant1}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L2VNI_Tenant1 SVI</span>
     <span class="na">nxos_interface</span><span class="pi">:</span>
       <span class="na">interface</span><span class="pi">:</span> <span class="s">vlan"{{ item.vlan_id }}"</span>
       <span class="na">fabric_forwarding_anycast_gateway</span><span class="pi">:</span> <span class="no">true</span>
     <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant1</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L3VNI_Tenant1 SVI</span>
     <span class="na">nxos_interface</span><span class="pi">:</span>
       <span class="na">interface</span><span class="pi">:</span> <span class="s">vlan"{{ L3VNI_Tenant1[0].vlan_id }}"</span>
       <span class="na">ip_forward</span><span class="pi">:</span> <span class="s">enable</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure VTEP Tunnel</span>
     <span class="na">nxos_vxlan_vtep</span><span class="pi">:</span>
        <span class="na">interface</span><span class="pi">:</span> <span class="s">nve1</span>
        <span class="na">shutdown</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
        <span class="na">source_interface</span><span class="pi">:</span> <span class="s">Loopback1</span>
        <span class="na">host_reachability</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L2VNI_Tenant1 to VTEP</span>
     <span class="na">nxos_vxlan_vtep_vni</span><span class="pi">:</span>
        <span class="na">interface</span><span class="pi">:</span> <span class="s">nve1</span>
        <span class="na">vni</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.vni</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">multicast_group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.mcast</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant1</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L3VNI_Tenant1 to VTEP</span>
     <span class="na">nxos_vxlan_vtep_vni</span><span class="pi">:</span>
        <span class="na">interface</span><span class="pi">:</span> <span class="s">nve1</span>
        <span class="na">vni</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L3VNI_Tenant1[0].vni</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">assoc_vrf</span><span class="pi">:</span> <span class="no">true</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>

</code></pre></div></div>

<h3 id="7-tenant-2-vxlan-playbook">(7) Tenant-2 VXLAN Playbook</h3>

<p>Running the playbook:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-playbook <span class="nt">-i</span> hosts <span class="nt">-c</span> ansible.netcommon.network_cli 7_configure_vxlan_leafs_tenant_2.yml
</code></pre></div></div>
<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configuring Leaf Switches</span>
  <span class="na">connection</span><span class="pi">:</span> <span class="s">ansible.netcommon.network_cli</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">leafs</span>
  <span class="na">tasks</span><span class="pi">:</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure VLAN to VNI</span>
     <span class="na">nxos_vlan</span><span class="pi">:</span>
       <span class="na">vlan_id</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.vlan_id</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">mapped_vni</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.vni</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.vlan_name</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">with_items</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant2</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L3VNI_Tenant2</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure Tenant VRF</span>
     <span class="na">nxos_vrf</span><span class="pi">:</span>
       <span class="na">vrf</span><span class="pi">:</span> <span class="s">Tenant-1</span>
       <span class="na">rd</span><span class="pi">:</span>  <span class="s">auto</span>
       <span class="na">vni</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L3VNI_Tenant2[0].vni</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure VRF AF</span>
     <span class="na">nxos_vrf_af</span><span class="pi">:</span>
       <span class="na">vrf</span><span class="pi">:</span> <span class="s">Tenant-2</span>
       <span class="na">route_target_both_auto_evpn</span><span class="pi">:</span> <span class="no">true</span>
       <span class="na">afi</span><span class="pi">:</span> <span class="s">ipv4</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure Anycast GW</span>
     <span class="na">nxos_overlay_global</span><span class="pi">:</span>
       <span class="na">anycast_gateway_mac</span><span class="pi">:</span> <span class="s">0000.2222.3333</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L2VNI_Tenant2</span>
     <span class="na">nxos_interface</span><span class="pi">:</span>
       <span class="na">interface</span><span class="pi">:</span> <span class="s">vlan"{{ item.vlan_id }}"</span>
     <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant2</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L3VNI_Tenant2</span>
     <span class="na">nxos_interface</span><span class="pi">:</span>
       <span class="na">interface</span><span class="pi">:</span> <span class="s">vlan"{{ L3VNI_Tenant2[0].vlan_id }}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Assign interface to Tenant VRF</span>
     <span class="na">nxos_vrf_interface</span><span class="pi">:</span>
       <span class="na">vrf</span><span class="pi">:</span> <span class="s">Tenant-2</span>
       <span class="na">interface</span><span class="pi">:</span> <span class="s2">"</span><span class="s">vlan{{</span><span class="nv"> </span><span class="s">item.vlan_id</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">with_items</span><span class="pi">:</span>
     <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant2</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="pi">-</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L3VNI_Tenant2</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Set interface IPv4 address on underlay</span>
     <span class="na">nxos_l3_interface</span><span class="pi">:</span>
       <span class="na">name</span><span class="pi">:</span> <span class="s2">"</span><span class="s">vlan{{</span><span class="nv"> </span><span class="s">item.vlan_id</span><span class="nv"> </span><span class="s">}}"</span>
       <span class="na">ipv4</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.ip_add</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{L2VNI_Tenant2}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L2VNI_Tenant2 SVI</span>
     <span class="na">nxos_interface</span><span class="pi">:</span>
       <span class="na">interface</span><span class="pi">:</span> <span class="s">vlan"{{ item.vlan_id }}"</span>
       <span class="na">fabric_forwarding_anycast_gateway</span><span class="pi">:</span> <span class="no">true</span>
     <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant2</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L3VNI_Tenant2 SVI</span>
     <span class="na">nxos_interface</span><span class="pi">:</span>
       <span class="na">interface</span><span class="pi">:</span> <span class="s">vlan"{{ L3VNI_Tenant2[0].vlan_id }}"</span>
       <span class="na">ip_forward</span><span class="pi">:</span> <span class="s">enable</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure VTEP Tunnel</span>
     <span class="na">nxos_vxlan_vtep</span><span class="pi">:</span>
        <span class="na">interface</span><span class="pi">:</span> <span class="s">nve1</span>
        <span class="na">shutdown</span><span class="pi">:</span> <span class="s2">"</span><span class="s">false"</span>
        <span class="na">source_interface</span><span class="pi">:</span> <span class="s">Loopback1</span>
        <span class="na">host_reachability</span><span class="pi">:</span> <span class="s2">"</span><span class="s">true"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L2VNI_Tenant2 to VTEP</span>
     <span class="na">nxos_vxlan_vtep_vni</span><span class="pi">:</span>
        <span class="na">interface</span><span class="pi">:</span> <span class="s">nve1</span>
        <span class="na">vni</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.vni</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">multicast_group</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">item.mcast</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">with_items</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L2VNI_Tenant2</span><span class="nv"> </span><span class="s">}}"</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>
   <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configure L3VNI_Tenant2 to VTEP</span>
     <span class="na">nxos_vxlan_vtep_vni</span><span class="pi">:</span>
        <span class="na">interface</span><span class="pi">:</span> <span class="s">nve1</span>
        <span class="na">vni</span><span class="pi">:</span> <span class="s2">"</span><span class="s">{{</span><span class="nv"> </span><span class="s">L3VNI_Tenant2[0].vni</span><span class="nv"> </span><span class="s">}}"</span>
        <span class="na">assoc_vrf</span><span class="pi">:</span> <span class="no">true</span>
     <span class="na">tags</span><span class="pi">:</span> <span class="s">vxlan</span>

</code></pre></div></div>

<h3 id="8-fabric-verification-playbook">(8) Fabric Verification Playbook</h3>

<p>Use the “cisco.nxos.nxos_command” task from the NXOS collection to run verification commands against our fabric.</p>

<p>On each switch we use the Ansible <strong>debug</strong> module to return the output of these commands to the terminal.</p>

<ol>
  <li>NXOS version</li>
  <li>Interface status</li>
  <li>Enabled Features</li>
  <li>CDP neighbours</li>
  <li>VLAN Status</li>
  <li>MAC address-table to verify our Ubuntu host is connected to the leaf switches and the access port is up.</li>
  <li>iBGP Neighbours</li>
  <li>EVPN Neighbours</li>
  <li>VTEP/NVE Interface status</li>
  <li>MAC and IP learning and host routes in the EVPN address family</li>
  <li>Tenant-1 routes</li>
  <li>Tenant-2 Routes</li>
  <li>Connectivity tests for underlay addresses and anycast SVIs for Tenant-1 and Tenant-2</li>
</ol>

<p>Running the playbook:</p>
<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span>ansible-playbook <span class="nt">-i</span> hosts <span class="nt">-c</span> ansible.netcommon.network_cli 8_verify_fabric.yml
</code></pre></div></div>

<div class="language-yaml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nn">---</span>

<span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">Configuring Leaf Switches</span>
  <span class="na">connection</span><span class="pi">:</span> <span class="s">ansible.netcommon.network_cli</span>
  <span class="na">gather_facts</span><span class="pi">:</span> <span class="no">false</span>
  <span class="na">hosts</span><span class="pi">:</span> <span class="s">leafs</span>
  <span class="na">tasks</span><span class="pi">:</span>
    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(1) Check Running Version</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">version_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">show version</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains bootflash:///nxos.9.3.7.bin</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=version_output.stdout_lines</span>


    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(2) Interface Status</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">interface_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">sh ip int br | exclude unass</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains Lo0</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=interface_output.stdout_lines</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(3) Enabled Features</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">feature_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">show feature | grep enabled</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains interface-vlan</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=feature_output.stdout_lines</span>


    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(4) CDP Neighours</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">cdp_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">show cdp neighbors | excl mgmt0</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains Eth1/1</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=cdp_output.stdout_lines</span>


    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(5) VLAN Status</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">vlan_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">show vlan</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains active</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=vlan_output.stdout_lines</span>


    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(6) MAC Address Table</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">mac_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">show mac address-table | exclude sup</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains MAC Address</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=vlan_output.stdout_lines</span>


    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(7) iBGP Neighbours</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">ibgp_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">show ip bgp summary</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains AS number </span><span class="m">65000</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=ibgp_output.stdout_lines</span>


    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(8) EVPN Neighbours</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">evpn_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">show bgp l2vpn evpn summary</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains AS number </span><span class="m">65000</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=evpn_output.stdout_lines</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(9) NVE Interface</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">nve_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">show nve interface</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains VXLAN</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=nve_output.stdout_lines</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(10) Check evpn MAC and IP learning</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">l2route_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">show l2route evpn mac-ip all</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains Orphan</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=l2route_output.stdout_lines</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(11) Check Tenant-1 Routes</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">Tenant1_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">show ip route vrf Tenant-1</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains IP Route Table</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=Tenant1_output.stdout_lines</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(12) Check Tenant-2 Routes</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">Tenant2_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">show ip route vrf Tenant-2</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains IP Route Table</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=Tenant2_output.stdout_lines</span>

    <span class="pi">-</span> <span class="na">name</span><span class="pi">:</span> <span class="s">(11) Connectivity</span>
      <span class="na">register</span><span class="pi">:</span> <span class="s">ping_output</span>
      <span class="s">cisco.nxos.nxos_command</span><span class="pi">:</span>
        <span class="na">commands</span><span class="pi">:</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">ping 10.1.1.101</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">ping 10.1.1.102</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">ping 10.1.1.200</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">ping 10.1.10.10 vrf Tenant-1</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">ping 10.1.10.11 vrf Tenant-1</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">ping 10.1.110.1 vrf Tenant-2</span>
        <span class="pi">-</span> <span class="na">command</span><span class="pi">:</span> <span class="s">ping 10.1.111.1 vrf Tenant-2</span>
        <span class="na">wait_for</span><span class="pi">:</span>
          <span class="pi">-</span> <span class="s">result[0] contains icmp_seq</span>
    <span class="pi">-</span> <span class="na">debug</span><span class="pi">:</span> <span class="s">var=ping_output.stdout_lines</span>

</code></pre></div></div>

  </div><a class="u-url" href="/2021/07/14/Infrastructure-As-Code-Using-Ansible-to-Deploy-a-Nexus-9000-EVPN-and-VXLAN-Fabric.html" hidden></a>
</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Jamie Sullivan&#39;s Blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Jamie Sullivan&#39;s Blog</li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/j-sulliman"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">j-sulliman</span></a></li><li><a href="https://www.linkedin.com/in/jamie-sullivan-71575421"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#linkedin"></use></svg> <span class="username">jamie-sullivan-71575421</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Personal Blog for Networking, Datacenter and automation / programmability.  All content is my own and does not represent the views of my employer.</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
